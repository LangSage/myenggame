<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü—É—Ç—å –í–µ—Ä—ã ‚Äî –ö–ª–∞—Å—Å–Ω–∞—è –ò–≥—Ä–∞</title>
  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    :root{
      --board-cols: 12;          /* >=100 –∫–ª–µ—Ç–æ–∫: 12x10 = 120 */
      --board-rows: 10;
      --cell-size: 60px;         /* JS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –ø–æ–¥ —ç–∫—Ä–∞–Ω */
      --cell-gap: 8px;
      --hud-h: 64px;
    }
    html,body{height:100%; margin:0; background:#efe9d9;}
    body{font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    /* Top HUD */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:var(--hud-h); z-index:30;
      background:rgba(255,255,255,.88); backdrop-filter:saturate(1.4) blur(6px);
      border-bottom:1px solid #eadfcf;
      display:flex; align-items:center; gap:10px; padding:8px 12px;
    }
    .brand{font-weight:800}
    .sp{flex:1}
    .btn-roll{font-weight:700}

    /* Stage (board area) */
    .stage{
      position:fixed; inset:var(--hud-h) 0 0 0; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 20% -10%, #fff, #f7f5ef 60%, #ece7d8);
    }
    .board{
      position:relative;
      display:grid;
      grid-template-columns: repeat(var(--board-cols), var(--cell-size));
      grid-template-rows: repeat(var(--board-rows), var(--cell-size));
      gap: var(--cell-gap);
      padding: 12px;
      border-radius: 18px;
      background:#fff url('./assets/bg_map.jpg') center/cover no-repeat;
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      max-width: 100vw;
      max-height: calc(100vh - var(--hud-h));
    }
    .cell{
      position:relative; border-radius:12px; background:#faf8f2dd;
      border:2px solid #e7dfcc; backdrop-filter:saturate(1.2) blur(1px);
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:6px; font-weight:600; font-size:12px; line-height:1.1;
      user-select:none; transition:transform .12s ease;
    }
    .cell:hover{transform:translateY(-2px)}
    .cell .idx{position:absolute; top:4px; left:6px; font-size:10px; opacity:.7}
    .cell .icon{font-size:18px; display:block}
    .badge-chip{font-size:10px; color:#fff; display:inline-block; padding:2px 6px; border-radius:999px; margin-top:4px}
    .chip-quiz{background:#f59e0b}
    .chip-bless{background:#10b981}
    .chip-chal{background:#ef4444}
    .chip-story{background:#6b7280}
    .cell.type-start{border-color:#b0d7a6}
    .cell.type-finish{border-color:#b5a6d7}

    /* Pawns */
    .pawn{
      position:absolute; width:28px;height:28px;border-radius:50%;
      border:2px solid #111; box-shadow:0 4px 10px rgba(0,0,0,.2); transform:translate(-50%,-50%);
      background-size:cover; background-position:center; background-color:#ddd;
    }
    .pawn.red{background-image:url('./assets/pawn_red.png')}
    .pawn.blue{background-image:url('./assets/pawn_blue.png')}

    /* Floating event bubble */
    .event-card{
      position:fixed; left:10px; bottom:10px; z-index:20;
      border:2px dashed #e5dccc; border-radius:12px; padding:8px 10px; background:#fffdf7cc;
      max-width:min(520px, 92vw);
      backdrop-filter:saturate(1.2) blur(4px);
      font-size:14px;
    }

    /* Dice */
    .dice{width:50px;height:50px;border-radius:12px;border:2px solid #e2e8f0; display:flex;align-items:center;justify-content:center;font-size:24px;background:#fff; box-shadow: inset 0 2px 0 rgba(0,0,0,.05);}
    .dice.shake{animation:shake .6s ease}
    @keyframes shake{0%,100%{transform:translate(0,0)}20%{transform:translate(-4px,2px)}40%{transform:translate(4px,-2px)}60%{transform:translate(-3px,2px)}80%{transform:translate(3px,-1px)}}

    /* Modal */
    .modal-backdrop-custom{
      position:fixed; inset:0; background:rgba(20,16,5,.6);
      display:none; align-items:center; justify-content:center; z-index:40;
    }
    .modal-backdrop-custom.show{display:flex}
    .modal-card{
      max-width:820px; width:calc(100% - 24px); background:#fff; border-radius:18px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25); border:1px solid #eadfcf;
    }
    .answer{border:1px solid #e5e7eb; border-radius:10px; padding:10px; cursor:pointer; background:#fff}
    .answer:hover{background:#f7fafc}
    .answer.correct{border-color:#10b981; background:#ecfdf5}
    .answer.wrong{border-color:#ef4444; background:#fef2f2}

    /* Setup overlay (2 teams only) */
    .setup{
      position:fixed; inset:0; background:linear-gradient(180deg,#fff, #f3eee0);
      display:flex; align-items:center; justify-content:center; z-index:50;
      padding:18px;
    }
    .setup-card{max-width:760px; width:100%; background:#fff; border:1px solid #eadfcf; border-radius:18px; padding:16px}
  </style>
</head>
<body>

<!-- Top HUD -->
<div class="topbar">
  <div class="brand">üó∫Ô∏è –ü—É—Ç—å –í–µ—Ä—ã</div>
  <div class="sp"></div>
  <div class="d-flex align-items-center gap-2">
    <div id="turnName" class="fw-bold">‚Äî</div>
    <div id="dice" class="dice" title="–ö—É–±–∏–∫">üé≤</div>
    <button id="rollBtn" class="btn btn-roll btn-success">–ë—Ä–æ—Å–∏—Ç—å</button>
    <button id="fsBtn" class="btn btn-outline-secondary">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
    <button id="endBtn" class="btn btn-outline-danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  </div>
</div>

<!-- Stage (board) -->
<div class="stage">
  <section id="board" class="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ">
    <!-- –∫–ª–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Å—Ç JS -->
  </section>
  <!-- Floating event -->
  <div id="eventPanel" class="event-card">
    <div class="d-flex align-items-center gap-2">
      <img src="./assets/icon_scroll.jpeg" onerror="this.style.display='none'" alt="" width="18" height="18">
      <strong>–°–æ–±—ã—Ç–∏–µ</strong>
    </div>
    <div id="eventText" class="mt-1">–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª, –∑–∞—Ç–µ–º ¬´–ë—Ä–æ—Å–∏—Ç—å¬ª.</div>
  </div>
</div>

<!-- Setup (2 –∫–æ–º–∞–Ω–¥—ã, –∫—Ä–∞—Å–Ω—ã–µ –∏ —Å–∏–Ω–∏–µ) -->
<section id="setup" class="setup" aria-modal="true" aria-hidden="false">
  <div class="setup-card">
    <h1 class="h4 mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Ç–∏–∏ (2 –∫–æ–º–∞–Ω–¥—ã)</h1>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ 1 (–∫—Ä–∞—Å–Ω—ã–µ)</label>
        <input id="name1" class="form-control" value="–ö—Ä–∞—Å–Ω—ã–µ">
      </div>
      <div class="col-md-6">
        <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ 2 (—Å–∏–Ω–∏–µ)</label>
        <input id="name2" class="form-control" value="–°–∏–Ω–∏–µ">
      </div>
      <div class="col-12 d-flex gap-2">
        <button id="startBtn" class="btn btn-primary px-4">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="fsBtnSetup" class="btn btn-outline-secondary">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
        <span class="text-muted d-none d-sm-inline">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã.</span>
      </div>
    </div>
  </div>
</section>

<!-- Modal (–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞/–∫–∞—Ä—Ç—ã) -->
<div id="modal" class="modal-backdrop-custom" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <div class="d-flex justify-content-between align-items-start">
      <h3 id="modalTitle" class="h5 mb-2">‚Äî</h3>
      <button id="modalClose" class="btn btn-sm btn-outline-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="modalBody" class="mt-1"></div>
    <div id="modalFooter" class="mt-3 d-flex gap-2 justify-content-end"></div>
  </div>
</div>

<!-- Sounds (optional; game works without the files) -->
<audio id="sfxDice" src="./assets/sfx_dice.wav" preload="auto"></audio>
<audio id="sfxMove" src="./assets/sfx_move.wav" preload="auto"></audio>
<audio id="sfxCorrect" src="./assets/sfx_correct.wav" preload="auto"></audio>
<audio id="sfxWrong" src="./assets/sfx_wrong.wav" preload="auto"></audio>
<audio id="sfxBless" src="./assets/sfx_blessing.wav" preload="auto"></audio>
<audio id="sfxChal" src="./assets/sfx_challenge.wav" preload="auto"></audio>
<audio id="sfxWin" src="./assets/sfx_win.wav" preload="auto"></audio>

<script>
(()=>{
  // ---------------------------
  // Board size (>=100 cells)
  // ---------------------------
  const BOARD_COLS = 12;
  const BOARD_ROWS = 10;
  const TILE_COUNT = BOARD_COLS * BOARD_ROWS; // 120

  // ---------------------------
  // Specials generator (no PRAYER)
  // ---------------------------
  function buildSpecials(){
    const S = {};
    S[1] = {type:'start',  label:'–°—Ç–∞—Ä—Ç ‚Äî –≠–¥–µ–º', icon:'üåø'};
    S[TILE_COUNT] = {type:'finish', label:'–§–∏–Ω–∏—à ‚Äî –ë–æ–∂—å—è —Å–µ–º—å—è', icon:'‚ú®'};

    // Story beats across the path
    const storyIdx = [6, 20, 40, 60, 85, 110].filter(i=>i<TILE_COUNT);
    storyIdx.forEach((i,k)=>{
      const labels = ['–≠–¥–µ–º ‚Äî –ü–µ—Ä–≤–∞—è —Å–µ–º—å—è','–ù–æ–π ‚Äî –°–ø–∞—Å—ë–Ω–Ω–∞—è —Å–µ–º—å—è','–ê–≤—Ä–∞–∞–º ‚Äî –û–±–µ—Ç–æ–≤–∞–Ω–∏–µ','–ò–∞–∫–æ–≤ ‚Äî 12 –∫–æ–ª–µ–Ω','–ù–∞—Ä–æ–¥ –ò–∑—Ä–∞–∏–ª—è','–¶–µ—Ä–∫–æ–≤—å ‚Äî –û–¥–Ω–∞ —Å–µ–º—å—è'];
      const icons  = ['üåø','‚õµ','‚≠ê','üß≠','üïé','‚õ™'];
      S[i] = {type:'story', label:labels[k]||'–ò—Å—Ç–æ—Ä–∏—è', icon:icons[k]||'üìú'};
    });

    // Many quizzes
    const quizIdx = [10,12,18,24,28,33,36,42,48,52,55,58,63,66,69,73,76,83,88,94,97,101,104,108,112,116].filter(i=>i<TILE_COUNT);
    quizIdx.forEach(i=>S[i]={type:'quiz', label:'–í–æ–ø—Ä–æ—Å', icon:'‚ùì'});

    // Blessings sprinkled
    const blessIdx = [8,14,22,30,38,46,54,62,70,78,86,95,103,111,118].filter(i=>i<TILE_COUNT);
    blessIdx.forEach(i=>S[i]={type:'bless', label:'–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ', icon:'üïäÔ∏è'});

    // Challenges (family-building)
    const chalIdx = [9,16,26,34,44,50,56,64,72,82,90,98,106,114].filter(i=>i<TILE_COUNT);
    chalIdx.forEach(i=>S[i]={type:'chal', label:'–ò—Å–ø—ã—Ç–∞–Ω–∏–µ', icon:'‚ö†Ô∏è'});

    return S;
  }
  const SPECIALS = buildSpecials();

  // ---------------------------
  // Decks
  // ---------------------------
  function q(question, options, answerIndex, ref){ return {question, options, answerIndex, ref}; }
  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  const QUIZ_DECK = shuffle([
    // Eden & early Genesis
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö —Å—ã–Ω–æ–≤–µ–π –ê–¥–∞–º–∞ –∏ –ï–≤—ã?', ['–ö–∞–∏–Ω –∏ –ê–≤–µ–ª—å','–î–∞–≤–∏–¥ –∏ –ò–æ–Ω–∞—Ñ–∞–Ω','–ü—ë—Ç—Ä –∏ –ê–Ω–¥—Ä–µ–π'], 0, '–ë—ã—Ç. 4:1‚Äì2'),
    q('–ì–¥–µ –∂–∏–ª–∞ –ø–µ—Ä–≤–∞—è —Å–µ–º—å—è?', ['–≠–¥–µ–º','–ò–µ—Ä—É—Å–∞–ª–∏–º','–ù–∞–∑–∞—Ä–µ—Ç'], 0, '–ë—ã—Ç. 2'),
    q('–ö—Ç–æ —É–±–∏–ª –ê–≤–µ–ª—è?', ['–ö–∞–∏–Ω','–õ–∞–º–µ—Ö','–ù–∏–º—Ä–æ–¥'], 0, '–ë—ã—Ç. 4'),
    q('–ö–æ–≥–æ –ë–æ–≥ –¥–∞–ª –≤–º–µ—Å—Ç–æ –ê–≤–µ–ª—è?', ['–°–∏—Ñ–∞','–°–∏–º–∞','–°–∞—É–ª–∞'], 0, '–ë—ã—Ç. 4:25'),

    // Noah & Flood
    q('–ö—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –∫–æ–≤—á–µ–≥?', ['–ù–æ–π','–ú–æ–∏—Å–µ–π','–ê–≤—Ä–∞–∞–º'], 0, '–ë—ã—Ç. 6‚Äì9'),
    q('–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ª–∏–ª—Å—è –¥–æ–∂–¥—å –≤–æ –≤—Ä–µ–º—è –ø–æ—Ç–æ–ø–∞?', ['40','7','3'], 0, '–ë—ã—Ç. 7:12'),
    q('–ö–∞–∫–æ–π –∑–Ω–∞–∫ –ë–æ–≥ –¥–∞–ª –ø–æ—Å–ª–µ –ø–æ—Ç–æ–ø–∞?', ['–†–∞–¥—É–≥–∞','–û–≥–æ–Ω—å','–ö–∞–º–µ–Ω–Ω–∏–∫'], 0, '–ë—ã—Ç. 9:13'),
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ —Å—ã–Ω–æ–≤–µ–π –ù–æ—è?', ['–°–∏–º, –•–∞–º, –ò–∞—Ñ–µ—Ç','–ö–∞–∏–Ω, –ê–≤–µ–ª—å, –°–∏—Ñ','–ü—ë—Ç—Ä, –ò–∞–∫–æ–≤, –ò–æ–∞–Ω–Ω'], 0, '–ë—ã—Ç. 5‚Äì10'),

    // Abraham
    q('–ò–∑ –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω—ã –ë–æ–≥ –ø–æ–∑–≤–∞–ª –ê–≤—Ä–∞–∞–º–∞?', ['–£—Ä –•–∞–ª–¥–µ–π—Å–∫–∏–π','–ï–≥–∏–ø–µ—Ç','–°–∏–¥–æ–Ω'], 0, '–ë—ã—Ç. 11:31'),
    q('–ß—Ç–æ –ë–æ–≥ –ø–æ–æ–±–µ—â–∞–ª –ê–≤—Ä–∞–∞–º—É?', ['–í–µ–ª–∏–∫–∏–π –Ω–∞—Ä–æ–¥','–ì–æ—Ä—É –∑–æ–ª–æ—Ç–∞','–î–≤–æ—Ä–µ—Ü'], 0, '–ë—ã—Ç. 12:2'),
    q('–ò–º—è —Å—ã–Ω–∞ –æ–±–µ—Ç–æ–≤–∞–Ω–∏—è –ê–≤—Ä–∞–∞–º–∞ –∏ –°–∞—Ä—ã:', ['–ò—Å–∞–∞–∫','–ò—à–º–∞–∏–ª','–ï—Å–∞—É'], 0, '–ë—ã—Ç. 21'),
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ –ø–ª–µ–º—è–Ω–Ω–∏–∫–∞ –ê–≤—Ä–∞–∞–º–∞?', ['–õ–æ—Ç','–ò–æ–≤','–°–∞–º—Å–æ–Ω'], 0, '–ë—ã—Ç. 12‚Äì19'),

    // Jacob / 12 tribes
    q('–î—Ä—É–≥–æ–µ –∏–º—è –ò–∞–∫–æ–≤–∞ ‚Äî —ç—Ç–æ‚Ä¶', ['–ò–∑—Ä–∞–∏–ª—å','–ò—Å–∞–≤','–ò—É–¥–∞'], 0, '–ë—ã—Ç. 32:28'),
    q('–°–∫–æ–ª—å–∫–æ —Å—ã–Ω–æ–≤–µ–π –±—ã–ª–æ —É –ò–∞–∫–æ–≤–∞?', ['12','10','7'], 0, '–ë—ã—Ç. 35:22‚Äì26'),
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ –ª—é–±–∏–º–æ–≥–æ —Å—ã–Ω–∞ –ò–∞–∫–æ–≤–∞, –ø–æ–ª—É—á–∏–≤—à–µ–≥–æ –æ—Å–æ–±—É—é –æ–¥–µ–∂–¥—É?', ['–ò–æ—Å–∏—Ñ','–î–∞–Ω','–ì–∞–¥'], 0, '–ë—ã—Ç. 37'),
    q('–ö—Ç–æ –ø—Ä–æ–¥–∞–ª –ò–æ—Å–∏—Ñ–∞ –≤ –ï–≥–∏–ø–µ—Ç?', ['–ë—Ä–∞—Ç—å—è','–§–∏–ª–∏—Å—Ç–∏–º–ª—è–Ω–µ','–ú–æ–∞–≤–∏—Ç—è–Ω–µ'], 0, '–ë—ã—Ç. 37'),

    // Israel & Moses
    q('–ö—Ç–æ –≤—ã–≤–µ–ª –ò–∑—Ä–∞–∏–ª—å –∏–∑ –ï–≥–∏–ø—Ç–∞?', ['–ú–æ–∏—Å–µ–π','–ò–∏—Å—É—Å –ù–∞–≤–∏–Ω','–°–∞–º—É–∏–ª'], 0, '–ò—Å—Ö. 12‚Äì14'),
    q('–ù–∞ –∫–∞–∫–æ–π –≥–æ—Ä–µ –ú–æ–∏—Å–µ–π –ø–æ–ª—É—á–∏–ª –∑–∞–ø–æ–≤–µ–¥–∏?', ['–°–∏–Ω–∞–π','–ö–∞—Ä–º–∏–ª','–ì–æ–ª–≥–æ—Ñ–∞'], 0, '–ò—Å—Ö. 19‚Äì20'),
    q('–°–∫–æ–ª—å–∫–æ –∑–∞–ø–æ–≤–µ–¥–µ–π –Ω–∞ —Å–∫—Ä–∏–∂–∞–ª—è—Ö?', ['10','7','12'], 0, '–ò—Å—Ö. 20'),

    // Kings & Prophets
    q('–ö—Ç–æ –±—ã–ª –ø–∞—Å—Ç—É—Ö–æ–º –∏ —Å—Ç–∞–ª —Ü–∞—Ä—ë–º –ò–∑—Ä–∞–∏–ª—è?', ['–î–∞–≤–∏–¥','–°–∞—É–ª','–°–æ–ª–æ–º–æ–Ω'], 0, '1 –¶–∞—Ä. 16'),
    q('–ö—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –ø–µ—Ä–≤—ã–π —Ö—Ä–∞–º –≤ –ò–µ—Ä—É—Å–∞–ª–∏–º–µ?', ['–°–æ–ª–æ–º–æ–Ω','–î–∞–≤–∏–¥','–ò–ª–∏—è'], 0, '3 –¶–∞—Ä. 6'),

    // New Testament & Church
    q('–ö—Ç–æ —Ä–æ–¥–∏–ª—Å—è –≤ –í–∏—Ñ–ª–µ–µ–º–µ?', ['–ò–∏—Å—É—Å','–ú–æ–∏—Å–µ–π','–ò–æ–∞–Ω–Ω'], 0, '–ú—Ñ. 2'),
    q('–ö—Ç–æ –∫—Ä–µ—Å—Ç–∏–ª –ò–∏—Å—É—Å–∞?', ['–ò–æ–∞–Ω–Ω –ö—Ä–µ—Å—Ç–∏—Ç–µ–ª—å','–ü—ë—Ç—Ä','–ò–∞–∫–æ–≤'], 0, '–ú—Ñ. 3'),
    q('–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –¥–µ–Ω—å –ü—è—Ç–∏–¥–µ—Å—è—Ç–Ω–∏—Ü—ã?', ['–°–æ—à—ë–ª –°–≤—è—Ç–æ–π –î—É—Ö','–†–∞–∑—Ä—É—à–∏–ª—Å—è —Ö—Ä–∞–º','–°–æ—à–ª–∞ –º–∞–Ω–Ω–∞'], 0, '–î–µ—è–Ω. 2'),
    q('–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –º–Ω–æ–≥–æ –ø–æ—Å–ª–∞–Ω–∏–π –¶–µ—Ä–∫–≤–∏?', ['–ü–∞–≤–µ–ª','–ù–æ–∞—Ö','–ù–∞—Ö–æ—Ä'], 0, '–î–µ—è–Ω./–ü–æ—Å–ª–∞–Ω–∏—è'),
    q('–ö—Ç–æ –≥–ª–∞–≤–∞ –¶–µ—Ä–∫–≤–∏?', ['–•—Ä–∏—Å—Ç–æ—Å','–ü—ë—Ç—Ä','–ú–æ–∏—Å–µ–π'], 0, '–ï—Ñ. 1:22'),
    q('–ß—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ö—Ä–∏—Å—Ç–∏–∞–Ω –∫–∞–∫ —Å–µ–º—å—é?', ['–í–µ—Ä–∞ –≤–æ –•—Ä–∏—Å—Ç–∞','–û–¥–∏–Ω —è–∑—ã–∫','–û–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'], 0, '–ì–∞–ª. 3:26‚Äì28'),

    // Extra variety
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –ò–æ–∞–Ω–Ω–∞ –ö—Ä–µ—Å—Ç–∏—Ç–µ–ª—è?', ['–ó–∞—Ö–∞—Ä–∏—è –∏ –ï–ª–∏–∑–∞–≤–µ—Ç–∞','–ò–æ—Å–∏—Ñ –∏ –ú–∞—Ä–∏—è','–ê–Ω–Ω–∞ –∏ –ï–ª–∫–∞–Ω–∞'], 0, '–õ–∫. 1'),
    q('–ì–¥–µ –≤—ã—Ä–æ—Å –ò–∏—Å—É—Å?', ['–ù–∞–∑–∞—Ä–µ—Ç','–í–∏—Ñ–ª–µ–µ–º','–ò–µ—Ä–∏—Ö–æ–Ω'], 0, '–õ–∫. 2'),
    q('–ö—Ç–æ –±—ã–ª –±—Ä–∞—Ç–æ–º –ú–∞—Ä–∏–∏ –∏ –ú–∞—Ä—Ñ—ã?', ['–õ–∞–∑–∞—Ä—å','–ù–∏–∫–æ–¥–∏–º','–í–∞—Ä—Ç–∏–º–µ–π'], 0, '–ò–Ω. 11'),
    q('–ö–æ–≥–æ –Ω–∞–∑–≤–∞–ª–∏ ¬´—Å—ã–Ω–∞–º–∏ –≥—Ä–æ–º–∞¬ª?', ['–ò–∞–∫–æ–≤–∞ –∏ –ò–æ–∞–Ω–Ω–∞','–ü–µ—Ç—Ä–∞ –∏ –ê–Ω–¥—Ä–µ—è','–§–æ–º—É –∏ –§–∏–ª–∏–ø–ø–∞'], 0, '–ú–∫. 3:17'),
    q('–°–∫–æ–ª—å–∫–æ —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑–±—Ä–∞–ª –ò–∏—Å—É—Å?', ['12','70','3'], 0, '–õ–∫. 6'),
    q('–ö—Ç–æ —É–≤–∏–¥–µ–ª —Ä–∞–¥—É–≥—É –∫–∞–∫ –∑–Ω–∞–∫ –∑–∞–≤–µ—Ç–∞?', ['–ù–æ–π','–ê–≤—Ä–∞–∞–º','–ú–æ–∏—Å–µ–π'], 0, '–ë—ã—Ç. 9'),
    q('–ö–æ–≥–æ –ë–æ–≥ –∏—Å–ø—ã—Ç–∞–ª –ø—Ä–æ—Å—å–±–æ–π –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Å—ã–Ω–∞?', ['–ê–≤—Ä–∞–∞–º–∞','–ò–∞–∫–æ–≤–∞','–°–∞–º—É–∏–ª–∞'], 0, '–ë—ã—Ç. 22')
  ]);

  const BLESSINGS = shuffle([
    ['–û–±–æ–¥—Ä–µ–Ω–∏–µ','–°–∫–∞–∂–∏—Ç–µ, –∑–∞ —á—Ç–æ –≤—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –≤ —Å–µ–º—å–µ. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +1.'],
    ['–°–ª—É–∂–µ–Ω–∏–µ','–ù–∞–∑–æ–≤–∏—Ç–µ, –∫–∞–∫ –ø–æ–º–æ–∂–µ—Ç–µ –¥–æ–º–∞. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +2.'],
    ['–ï–¥–∏–Ω—Å—Ç–≤–æ','–°–∫–∞–∂–∏—Ç–µ –≤–º–µ—Å—Ç–µ: ¬´–ú—ã ‚Äî –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞!¬ª. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +1.'],
    ['–ù–∞–¥–µ–∂–¥–∞','–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –±–∏–±–ª–µ–π—Å–∫–∏–º –æ–±–µ—â–∞–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –≤–∞—Å –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +1.'],
    ['–î–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞','–°–¥–µ–ª–∞–π—Ç–µ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —Å–æ—Å–µ–¥—É –ø–æ –∫–æ–º–∞–Ω–¥–µ. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +1.'],
    ['–ü–æ–¥–¥–µ—Ä–∂–∫–∞','–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –¥—Ä—É–≥–∞ –≤ –∫–ª–∞—Å—Å–µ. –ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +2.']
  ]);

  const CHALLENGES = shuffle([
    ['–¢–µ—Ä–ø–µ–Ω–∏–µ','–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.'],
    ['–ß–µ—Å—Ç–Ω–æ—Å—Ç—å','–ù–∞–∑–æ–≤–∏—Ç–µ, —á—Ç–æ –≥–æ—Ç–æ–≤—ã —É–ª—É—á—à–∞—Ç—å –¥–æ–º–∞. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–£—Å—Ç—É–ø—á–∏–≤–æ—Å—Ç—å','–ù–∞–∑–∞–¥ –Ω–∞ 1 –∏ —Å–∫–∞–∂–∏—Ç–µ: ¬´–ü—É—Å—Ç—å –±—É–¥–µ—Ç –ø–æ-—Ç–≤–æ–µ–º—É¬ª.'],
    ['–°–ª—É—à–∞–Ω–∏–µ','–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å–∫–∞–∂–µ—Ç –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∞ –≤—ã –Ω–µ –ø–µ—Ä–µ–±—å—ë—Ç–µ. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–ó–∞–±–æ—Ç–∞','–ù–∞–∑–Ω–∞—á—å—Ç–µ –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –¥–µ–ª–æ –¥–ª—è —Å–µ–±—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–í–µ–∂–ª–∏–≤–æ—Å—Ç—å','–°–∫–∞–∂–∏ —Ç—Ä—ë–º –ª—é–¥—è–º –ø–æ –æ—á–µ—Ä–µ–¥–∏: ¬´–°–ø–∞—Å–∏–±–æ –∑–∞‚Ä¶¬ª. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–ú–∏—Ä','–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫ —Å–ø–æ—Ä ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –º–∏—Ä–Ω–æ —Ä–µ—à–∏—Ç—å. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.'],
    ['–©–µ–¥—Ä–æ—Å—Ç—å','–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–¥–µ–µ–π, —á–µ–º –º–æ–∂–Ω–æ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ–º–∞. –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–ü–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ','–°–∫–∞–∂–∏—Ç–µ –¥—Ä—É–≥—É –ø–æ –∫–æ–º–∞–Ω–¥–µ –¥–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å','–û–±–µ—â–∞–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–Ω–æ –¥–µ–ª–æ –±–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ','–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –æ–¥–Ω–æ –æ–±—â–µ–µ –¥–µ–ª–æ –≤—Å–µ–π –∫–æ–º–∞–Ω–¥–æ–π. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–ü—Ä–æ—â–µ–Ω–∏–µ','–ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ –ø—Ä–∏–º–µ—Ä —Ñ—Ä–∞–∑—ã-–∏–∑–≤–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.'],
    ['–í–Ω–∏–º–∞–Ω–∏–µ','–ü—è—Ç—å —Å–µ–∫—É–Ω–¥ –º–æ–ª—á–∞–Ω–∏—è –∏ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –∫–æ–º–∞–Ω–¥–µ. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–†–∞–∑–¥–µ–ª–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å','–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Ö–æ—Ä–æ—à–µ–º —Å–µ–º–µ–π–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏. –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–ü–æ–º–æ—â—å –º–ª–∞–¥—à–∏–º/—Å—Ç–∞—Ä—à–∏–º','–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–º–æ—â—å —Å–µ–≥–æ–¥–Ω—è. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–ü–æ—Ä—è–¥–æ–∫','–°–∫–∞–∂–∏—Ç–µ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —É–±–µ—Ä—ë—Ç–µ/–ø–æ–º–æ–µ—Ç–µ. –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–î–æ–±—Ä–æ—Ç–∞','–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å—é—Ä–ø—Ä–∏–∑ –¥–æ–±—Ä–æ—Ç—ã –¥–ª—è –¥–æ–º–∞. –•–æ–¥–∞ –Ω–µ—Ç.'],
    ['–û—Ç–≤–µ—Ç –Ω–∞ –Ω—É–∂–¥—É','–ù–∞–∑–æ–≤–∏—Ç–µ —á—å—é –Ω—É–∂–¥—É –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.'],
    ['–¢–∏—Ö–∞—è —Å–∏–ª–∞','–°–¥–µ–ª–∞–π—Ç–µ –¥–æ–±—Ä–æ –±–µ–∑ —Å–ª–æ–≤ (–∏–¥–µ—è). –ù–∞–∑–∞–¥ –Ω–∞ 1.'],
    ['–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å','–û–±–µ—â–∞–π—Ç–µ –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è –∫—É–¥–∞-—Ç–æ —Å–µ–≥–æ–¥–Ω—è. –•–æ–¥–∞ –Ω–µ—Ç.']
  ]);

  const STORY_SNIPPETS = [
    ['–≠–¥–µ–º ‚Äî –ü–µ—Ä–≤–∞—è —Å–µ–º—å—è','–°–µ–º—å—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ë–æ–∂—å–µ–π –ª—é–±–≤–∏ –∏ –∑–∞–±–æ—Ç—ã. (–ë—ã—Ç. 1‚Äì2)'],
    ['–ü–∞–¥–µ–Ω–∏–µ –∏ –Ω–∞–¥–µ–∂–¥–∞','–î–∞–∂–µ –ø–æ—Å–ª–µ –≥—Ä–µ—Ö–∞ –ë–æ–≥ –æ–±–µ—â–∞–ª –°–ø–∞—Å–∏—Ç–µ–ª—è. (–ë—ã—Ç. 3:15)'],
    ['–ù–æ–π ‚Äî –°–ø–∞—Å—ë–Ω–Ω–∞—è —Å–µ–º—å—è','–°–µ–º—å—è –ù–æ—è –¥–æ–≤–µ—Ä–∏–ª–∞—Å—å –ë–æ–≥—É –∏ –≤–æ—à–ª–∞ –≤ –∫–æ–≤—á–µ–≥. (–ë—ã—Ç. 6‚Äì9)'],
    ['–û–±–µ—Ç–æ–≤–∞–Ω–∏–µ –ê–≤—Ä–∞–∞–º—É','¬´–°–¥–µ–ª–∞—é —Ç–µ–±—è –≤–µ–ª–∏–∫–∏–º –Ω–∞—Ä–æ–¥–æ–º¬ª. (–ë—ã—Ç. 12:2)'],
    ['–ò–∞–∫–æ–≤ / 12 –∫–æ–ª–µ–Ω','–û—Ç –ò–∞–∫–æ–≤–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å –∫–æ–ª–µ–Ω. (–ë—ã—Ç. 32; 49)'],
    ['–û–¥–Ω–∞ —Å–µ–º—å—è –≤–æ –•—Ä–∏—Å—Ç–µ','–í–æ –•—Ä–∏—Å—Ç–µ –ª—é–¥–∏ –∏–∑ –≤—Å–µ—Ö –Ω–∞—Ä–æ–¥–æ–≤ ‚Äî –æ–¥–Ω–∞ —Å–µ–º—å—è. (–î–µ—è–Ω. 2; –ì–∞–ª. 3)'],
  ];

  // ---------------------------
  // State
  // ---------------------------
  let players = []; // {id,name,color,position,skipTurns}
  let current = 0;
  let gameStarted = false;
  let gameOver = false;

  // ---------------------------
  // DOM
  // ---------------------------
  const el = {
    board: $('#board'),
    setup: $('#setup'),
    startBtn: $('#startBtn'),
    name1: $('#name1'),
    name2: $('#name2'),
    turnName: $('#turnName'),
    eventText: $('#eventText'),
    rollBtn: $('#rollBtn'),
    dice: $('#dice'),
    endBtn: $('#endBtn'),
    modal: $('#modal'),
    modalTitle: $('#modalTitle'),
    modalBody: $('#modalBody'),
    modalFooter: $('#modalFooter'),
    modalClose: $('#modalClose'),
    fsBtn: $('#fsBtn'),
    fsBtnSetup: $('#fsBtnSetup'),
    sfxDice: $('#sfxDice'),
    sfxMove: $('#sfxMove'),
    sfxCorrect: $('#sfxCorrect'),
    sfxWrong: $('#sfxWrong'),
    sfxBless: $('#sfxBless'),
    sfxChal: $('#sfxChal'),
    sfxWin: $('#sfxWin'),
  };
  function $(q,scope=document){ return scope.querySelector(q); }
  function ce(tag, cls, html){ const n=document.createElement(tag); if(cls) n.className=cls; if(html!=null) n.innerHTML=html; return n; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  // Fit board to full screen (compute cell size)
  function fitBoard(){
    const stage = document.querySelector('.stage').getBoundingClientRect();
    const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-gap')) || 8;
    const pad = 24; // board padding approx
    const cols = BOARD_COLS, rows = BOARD_ROWS;
    const sizeW = Math.floor((stage.width - pad - (cols-1)*gap) / cols);
    const sizeH = Math.floor((stage.height - pad - (rows-1)*gap) / rows);
    const size = Math.max(24, Math.min(sizeW, sizeH));
    document.documentElement.style.setProperty('--cell-size', size+'px');
  }
  window.addEventListener('resize', ()=>{ fitBoard(); placePawns(); });

  // Build board
  function serpentineIndexToGrid(i){
    const zero = i-1;
    const r = Math.floor(zero / BOARD_COLS);
    const c = zero % BOARD_COLS;
    const row = BOARD_ROWS - 1 - r;
    const col = (r % 2 === 0) ? c : (BOARD_COLS - 1 - c);
    return {row, col};
  }
  function buildBoard(){
    el.board.innerHTML='';
    el.board.style.setProperty('--board-cols', BOARD_COLS);
    el.board.style.setProperty('--board-rows', BOARD_ROWS);
    for(let i=1;i<=TILE_COUNT;i++){
      const spec = SPECIALS[i];
      const div = ce('div','cell'+(spec?(' type-'+spec.type):''));
      div.dataset.index = i;
      const badge = badgeFor(spec ? spec.type : '');
      const icon = ce('div','icon', spec ? (spec.icon) : '');
      const label = spec ? (spec.label) : '–ü—É—Ç—å';
      div.innerHTML = `<span class="idx">#${i}</span>${icon.outerHTML}<div class="small">${label}</div>${badge}`;
      const {row,col} = serpentineIndexToGrid(i);
      div.style.gridRow = (row+1);
      div.style.gridColumn = (col+1);
      el.board.appendChild(div);
    }
    fitBoard();
  }
  function badgeFor(type){
    const map = {
      quiz: '<div class="badge-chip chip-quiz">–í–ò–ö–¢–û–†–ò–ù–ê</div>',
      bless:'<div class="badge-chip chip-bless">–ë–õ–ê–ì–û–°–õ–û–í–ï–ù–ò–ï</div>',
      chal: '<div class="badge-chip chip-chal">–ò–°–ü–´–¢–ê–ù–ò–ï</div>',
      story:'<div class="badge-chip chip-story">–ò–°–¢–û–†–ò–Ø</div>',
      start:'<div class="badge-chip chip-story">–°–¢–ê–†–¢</div>',
      finish:'<div class="badge-chip chip-story">–§–ò–ù–ò–®</div>',
    };
    return map[type] || '';
  }

  // Pawns
  const COLORS = ['red','blue']; // only two teams
  function cellCenterPos(cellEl){
    const r = cellEl.getBoundingClientRect();
    const b = el.board.getBoundingClientRect();
    return { x: r.left - b.left + r.width/2, y: r.top - b.top + r.height/2 };
  }
  function placePawns(){
    el.board.querySelectorAll('.pawn').forEach(n=>n.remove());
    for(const p of players){
      const idx = clamp(p.position,1,TILE_COUNT);
      const cell = el.board.querySelector(`.cell[data-index="${idx}"]`);
      if(!cell) continue;
      const pos = cellCenterPos(cell);
      const pawn = ce('div', 'pawn '+p.color);
      const offset = (p.color==='red') ? {x:-10,y:-10} : {x:10,y:10};
      pawn.style.left = (pos.x + offset.x) + 'px';
      pawn.style.top  = (pos.y + offset.y) + 'px';
      pawn.title = `${p.name} @ ${idx}`;
      el.board.appendChild(pawn);
    }
  }

  // Modal
  function showModal(title, html, buttons=[]){
    el.modalTitle.textContent = title;
    el.modalBody.innerHTML = html;
    el.modalFooter.innerHTML = '';
    buttons.forEach(b=>{
      const btn = ce('button','btn '+(b.cls||'btn-secondary'));
      btn.textContent = b.label;
      btn.addEventListener('click', b.cb || closeModal);
      el.modalFooter.appendChild(btn);
    });
    el.modal.classList.add('show');
    el.modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    el.modal.classList.remove('show');
    el.modal.setAttribute('aria-hidden','true');
  }

  // Turn flow
  function currentPlayer(){ return players[current]; }
  function nextTurn(){
    if(gameOver) return;
    current = (current + 1) % players.length;
    const p = currentPlayer();
    el.turnName.textContent = p.name + (p.skipTurns>0?` (–ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ ${p.skipTurns})`:``);
    if(p.skipTurns>0){
      p.skipTurns--;
      nextTurn();
      return;
    }
  }

  // Move animation
  function moveBy(p, steps, cb){
    if(steps===0){ cb && cb(); return; }
    const dir = Math.sign(steps);
    const total = Math.abs(steps);
    let done = 0;
    function step(){
      if(gameOver) return;
      p.position += dir;
      p.position = clamp(p.position, 1, TILE_COUNT);
      placePawns();
      try{ el.sfxMove.currentTime=0; el.sfxMove.play().catch(()=>{});}catch(e){}
      done++;
      if(done<total && p.position>0 && p.position<TILE_COUNT){
        setTimeout(step, 120);
      }else{
        cb && cb();
      }
    }
    step();
  }

  // Dice
  function roll(){
    if(!gameStarted || gameOver) return;
    const p = currentPlayer();
    if(p.skipTurns>0){ nextTurn(); return; }
    el.dice.classList.add('shake');
    try{ el.sfxDice.currentTime=0; el.sfxDice.play().catch(()=>{});}catch(e){}
    el.rollBtn.disabled = true;
    const value = 1 + Math.floor(Math.random()*6);
    setTimeout(()=>{
      el.dice.classList.remove('shake');
      el.dice.textContent = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][value-1];
      const to = Math.min(TILE_COUNT - p.position, value);
      moveBy(p, to, ()=> onLand(p));
    }, 620);
  }

  // Landing
  function onLand(p){
    const idx = p.position;
    if(idx>=TILE_COUNT){ win(p); return; }
    const spec = SPECIALS[idx];
    if(!spec || spec.type==='story' || spec.type==='start'){
      const [title, text] = randomStoryForIndex(idx);
      el.eventText.innerHTML = `<strong>${title}</strong><br>${text}`;
      nextTurn(); el.rollBtn.disabled=false; return;
    }
    if(spec.type==='quiz') return handleQuiz(p);
    if(spec.type==='bless') return handleBlessing(p);
    if(spec.type==='chal') return handleChallenge(p);
    if(spec.type==='finish'){ win(p); return; }

    nextTurn(); el.rollBtn.disabled=false;
  }
  function randomStoryForIndex(i){
    if(i<=12) return STORY_SNIPPETS[0];
    if(i<=28) return STORY_SNIPPETS[1];
    if(i<=48) return STORY_SNIPPETS[2];
    if(i<=72) return STORY_SNIPPETS[3];
    if(i<=96) return STORY_SNIPPETS[4];
    return STORY_SNIPPETS[5];
  }

  // Handlers
  function handleQuiz(p){
    const card = QUIZ_DECK.length ? QUIZ_DECK.pop() : null;
    if(!card){
      const [title, text] = randomStoryForIndex(p.position);
      el.eventText.innerHTML = `<strong>${title}</strong><br>${text}`;
      nextTurn(); el.rollBtn.disabled=false; return;
    }
    const optsHtml = card.options.map((opt, idx)=>(
      `<div class="answer" data-idx="${idx}">${opt}</div>`
    )).join('');
    const ref = card.ref ? `<div class="small text-muted mt-2">–ú–µ—Å—Ç–æ –ü–∏—Å–∞–Ω–∏—è: ${card.ref}</div>` : '';
    showModal('–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚ùì', `
      <div class="mb-2 fw-bold">${card.question}</div>
      <div id="answers" class="d-grid gap-2">${optsHtml}</div>
      ${ref}
      <div class="small mt-3">–ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –±—Ä–æ—Å—å—Ç–µ –µ—â—ë —Ä–∞–∑. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –Ω–∞–∑–∞–¥ –Ω–∞ 1.</div>
    `);
    const answers = $('#answers');
    answers.querySelectorAll('.answer').forEach(a=>{
      a.addEventListener('click', ()=>{
        const chosen = +a.dataset.idx;
        const correct = (chosen === card.answerIndex);
        if(correct){
          a.classList.add('correct');
          try{ el.sfxCorrect.currentTime=0; el.sfxCorrect.play().catch(()=>{});}catch(e){}
          setTimeout(()=>{
            closeModal();
            el.rollBtn.disabled=false; // extra roll
          }, 450);
        }else{
          a.classList.add('wrong');
          try{ el.sfxWrong.currentTime=0; el.sfxWrong.play().catch(()=>{});}catch(e){}
          setTimeout(()=>{
            closeModal();
            moveBy(p, -1, ()=>{
              el.eventText.innerHTML = `<strong>–•–æ—Ä–æ—à–æ!</strong> –£—á–∏–º—Å—è –∏ –∏–¥—ë–º –¥–∞–ª—å—à–µ.`;
              nextTurn();
              el.rollBtn.disabled=false;
            });
          }, 450);
        }
      }, {once:true});
    });
  }

  function handleBlessing(p){
    const card = BLESSINGS.length ? BLESSINGS.pop() : ['–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ','–ò–¥–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –Ω–∞ +1.'];
    try{ el.sfxBless.currentTime=0; el.sfxBless.play().catch(()=>{});}catch(e){}
    showModal('–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ üïäÔ∏è', `
      <div class="fw-bold mb-1">${card[0]}</div>
      <div>${card[1]}</div>
    `, [{label:'–ü—Ä–∏–º–µ–Ω–∏—Ç—å', cls:'btn-success', cb: ()=>{
      closeModal();
      const move = /\+2/.test(card[1]) ? 2 : /\+1/.test(card[1]) ? 1 : 1;
      moveBy(p, Math.min(move, TILE_COUNT - p.position), ()=>{
        el.eventText.innerHTML = `<strong>–ë–æ–≥ —É–∫—Ä–µ–ø–ª—è–µ—Ç.</strong>`;
        nextTurn(); el.rollBtn.disabled=false;
      });
    }}]);
  }

  function handleChallenge(p){
    const card = CHALLENGES.length ? CHALLENGES.pop() : ['–ò—Å–ø—ã—Ç–∞–Ω–∏–µ','–ù–∞–∑–∞–¥ –Ω–∞ 1.'];
    try{ el.sfxChal.currentTime=0; el.sfxChal.play().catch(()=>{});}catch(e){}
    showModal('–ò—Å–ø—ã—Ç–∞–Ω–∏–µ ‚ö†Ô∏è', `
      <div class="fw-bold mb-1">${card[0]}</div>
      <div>${card[1]}</div>
    `, [{label:'–ü—Ä–∏–º–µ–Ω–∏—Ç—å', cls:'btn-outline-danger', cb: ()=>{
      closeModal();
      let delta = 0;
      if(/–Ω–∞–∑–∞–¥\s*–Ω–∞\s*1/i.test(card[1])) delta = -1;
      moveBy(p, delta, ()=>{
        if(/–ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ/i.test(card[1])) currentPlayer().skipTurns = (currentPlayer().skipTurns||0)+1;
        el.eventText.innerHTML = `<strong>–†–∞—Å—Ç—ë–º —á–µ—Ä–µ–∑ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏.</strong>`;
        nextTurn(); el.rollBtn.disabled=false;
      });
    }}]);
  }

  function win(p){
    if(gameOver) return;
    gameOver = true;
    try{ el.sfxWin.currentTime=0; el.sfxWin.play().catch(()=>{});}catch(e){}
    showModal('–§–∏–Ω–∏—à ‚ú®', `
      <p class="mb-1"><strong>${p.name}</strong> –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–∏!</p>
      <p class="mb-2">–û—Ç –ø–µ—Ä–≤–æ–π —Å–µ–º—å–∏ ‚Üí –ù–æ–π ‚Üí –ò–∑—Ä–∞–∏–ª—å ‚Üí –¶–µ—Ä–∫–æ–≤—å ‚Äî <strong>–º—ã –æ–¥–Ω–∞ –ë–æ–∂—å—è —Å–µ–º—å—è</strong>.</p>
    `, [{label:'–û–ö', cls:'btn-primary', cb: closeModal}]);
  }

  // Start game
  function startGame(){
    const names = [el.name1.value || '–ö—Ä–∞—Å–Ω—ã–µ', el.name2.value || '–°–∏–Ω–∏–µ'];
    players = [
      {id:0, name:names[0], color:'red',  position:1, skipTurns:0},
      {id:1, name:names[1], color:'blue', position:1, skipTurns:0},
    ];
    current = 0; gameOver=false; gameStarted=true;
    buildBoard();
    placePawns();
    el.turnName.textContent = players[0].name;
    el.eventText.innerHTML = `<strong>–°—Ç–∞—Ä—Ç ‚Äî –≠–¥–µ–º.</strong> –ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫!`;
    el.setup.setAttribute('aria-hidden','true');
    el.setup.style.display='none';
  }

  // Fullscreen toggle
  function toggleFullscreen(){
    const elem = document.documentElement;
    if (!document.fullscreenElement) {
      if (elem.requestFullscreen) elem.requestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
    }
    setTimeout(()=>{ fitBoard(); placePawns(); }, 250);
  }

  // Events
  el.startBtn.addEventListener('click', startGame);
  el.rollBtn.addEventListener('click', roll);
  document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); roll(); }});
  el.modalClose.addEventListener('click', closeModal);
  el.endBtn.addEventListener('click', ()=>{
    if(!gameOver){
      showModal('–ó–∞–≤–µ—Ä—à–∏—Ç—å?', `<div>–ó–∞–∫–æ–Ω—á–∏—Ç—å –ø–∞—Ä—Ç–∏—é —Å–µ–π—á–∞—Å?</div>`, [
        {label:'–û—Ç–º–µ–Ω–∞', cls:'btn-secondary', cb: closeModal},
        {label:'–ó–∞–≤–µ—Ä—à–∏—Ç—å', cls:'btn-danger', cb: ()=>{ closeModal(); gameOver=true; }}
      ]);
    }
  });
  el.fsBtn.addEventListener('click', toggleFullscreen);
  el.fsBtnSetup.addEventListener('click', toggleFullscreen);

  // Initial render
  buildBoard();
})();
</script>
</body>
</html>
