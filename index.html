<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Blind Fault Maze ‚Äî Fixed Levels</title>
<style>
  :root { --hud-bg: rgba(0,0,0,.6); --accent:#10b981; --danger:#ef4444; --text:#e5e7eb; }
  html,body{height:100%;margin:0;background:#000;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  #game{position:fixed;inset:0;overflow:hidden}
  canvas{position:absolute;inset:0;width:100%;height:100%;touch-action:none}
  .hud{position:fixed;left:0;right:0;top:env(safe-area-inset-top,0);padding:.5rem .75rem;display:flex;gap:.5rem;align-items:center;justify-content:space-between;background:linear-gradient(to bottom,rgba(0,0,0,.85),rgba(0,0,0,.2));pointer-events:none;user-select:none}
  .hud>*{pointer-events:auto}
  .pill{background:var(--hud-bg);border:1px solid rgba(255,255,255,.08);padding:.4rem .6rem;border-radius:999px;font-size:.9rem;display:inline-flex;gap:.6rem;align-items:center}
  .btn{background:var(--hud-bg);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:.5rem .8rem;border-radius:.75rem;font-weight:600;letter-spacing:.2px;cursor:pointer;transition:transform .08s ease}
  .btn:active{transform:scale(.98)}
  .btn-accent{border-color:rgba(16,185,129,.45);box-shadow:0 0 0 1px rgba(16,185,129,.15) inset}
  .btn-danger{border-color:rgba(239,68,68,.4)}
  .toggle{display:inline-flex;align-items:center;gap:.35rem;cursor:pointer;user-select:none}
  .toggle input{accent-color:var(--accent);width:1rem;height:1rem}
  .pad{position:fixed;left:0;right:0;bottom:calc(env(safe-area-inset-bottom,0) + .5rem);display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:64px;gap:.5rem;padding:0 .75rem}
  .pad .btn{font-size:1.15rem}.pad .sp{visibility:hidden}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at center,rgba(0,0,0,.65),rgba(0,0,0,.9) 60%,#000 100%);backdrop-filter:blur(2px)}
  .card{width:min(640px,92vw);border-radius:1rem;padding:1rem;background:rgba(17,24,39,.8);border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.4)}
  .card h1{margin:.2rem 0 .6rem;font-size:1.4rem}
  .muted{color:#9ca3af;font-size:.95rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  input,select,textarea{background:#0b0f17;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:.6rem;padding:.5rem .6rem}
  textarea{width:100%;min-height:140px;resize:vertical}
  .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;background:#0b0f17;border:1px solid rgba(255,255,255,.08);padding:.1rem .4rem;border-radius:.4rem}
  .flash-red{animation:flash .25s ease}
  @keyframes flash{0%{background:rgba(239,68,68,.25)}100%{background:transparent}}
  .footer{position:fixed;right:.5rem;bottom:calc(env(safe-area-inset-bottom,0) + 4.8rem);font-size:.8rem;color:#6b7280;opacity:.85;background:var(--hud-bg);padding:.25rem .5rem;border-radius:.5rem}
</style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>

  <!-- HUD -->
  <div class="hud">
    <div class="pill">
      <span>Deaths: <strong id="deaths">0</strong></span>
      <span>Steps: <strong id="steps">0</strong></span>
      <span>Time: <strong id="time">00:00</strong></span>
    </div>
    <div class="row">
      <button class="btn btn-accent" id="btnPing" title="Echo ping (3 uses)">Echo (3)</button>
      <label class="toggle"><input type="checkbox" id="assist" /> Assist blink</label>
      <button class="btn" id="btnMute">üîä</button>
      <button class="btn btn-danger" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- D-Pad -->
  <div class="pad">
    <span class="sp"></span><button class="btn" id="btnUp">‚ñ≤</button><span class="sp"></span>
    <button class="btn" id="btnLeft">‚óÄ</button><button class="btn" id="btnCenter" title="Stand / Echo (long-press)">‚óè</button><button class="btn" id="btnRight">‚ñ∂</button>
    <span class="sp"></span><button class="btn" id="btnDown">‚ñº</button><span class="sp"></span>
  </div>

  <div class="footer">Swipe or use the D-pad. Long-press center for Echo.</div>

  <!-- Start overlay -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <h1>Blind Fault Maze (Fixed)</h1>
      <p class="muted">Move through a black world. Only some tiles are safe ‚Äî the rest are deadly pits. You must <em>draw your own paper map</em> to find the path from <span class="key">S</span> to <span class="key">E</span>.</p>

      <div class="row" style="margin:.5rem 0;">
        <label>Level:
          <select id="levelSel">
            <option value="Serpent-15">Serpent-15 (default)</option>
            <option value="Serpent-20">Serpent-20</option>
            <option value="Custom">Custom (paste below)</option>
          </select>
        </label>
        <button class="btn" id="btnPrint">Print blank grid</button>
      </div>

      <details style="margin:.25rem 0 0">
        <summary class="muted">Custom level format</summary>
        <p class="muted" style="margin:.4rem 0">Paste ASCII map: <span class="key">S</span> = start, <span class="key">E</span> = exit, <span class="key">.</span> = safe, <span class="key">#</span> = pit. All rows must be equal width.</p>
      </details>
      <textarea id="customText" placeholder="Example:
S..............
##############.
...............
.##############
...............
##############.
...............
.##############
...............
##############.
...............
.##############
...............
##############.
..............E"></textarea>

      <div class="row" style="margin-top:.6rem">
        <button class="btn btn-accent" id="btnStart">Start</button>
        <button class="btn" id="btnMute2">üîä Toggle Sound</button>
      </div>
      <p class="muted" style="margin-top:.5rem">Audio placeholders: background <span class="key">back.mp3</span> (loop), lose <span class="key">lose.mp3</span>. Replace with your links later.</p>
    </div>
  </div>

  <!-- Win overlay -->
  <div class="overlay" id="winOverlay" style="display:none;">
    <div class="card">
      <h1>Exit Found! üéâ</h1>
      <p class="muted">Level: <span id="winLevel" class="key"></span></p>
      <div class="pill" style="margin:.5rem 0 1rem; display:inline-flex;">
        <span>Deaths: <strong id="sumDeaths"></strong></span>
        <span>Steps: <strong id="sumSteps"></strong></span>
        <span>Time: <strong id="sumTime"></strong></span>
      </div>
      <p class="muted">Best for this level: <span id="bestLine">‚Äî</span></p>
      <div class="row">
        <button class="btn btn-accent" id="btnReplay">Replay</button>
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="bgm" src="back.mp3" preload="auto" loop></audio>
<audio id="lose" src="lose.mp3" preload="auto"></audio>

<script>
/* ========= Fixed levels ========= */
const LEVELS = {
  "Serpent-15": {
    grid: [
"S..............",
"##############.",
"...............",
".##############",
"...............",
"##############.",
"...............",
".##############",
"...............",
"##############.",
"...............",
".##############",
"...............",
"##############.",
"..............E",
    ]
  },
  "Serpent-20": {
    grid: [
"S...................",
"###################.",
"....................",
".###################",
"....................",
"###################.",
"....................",
".###################",
"....................",
"###################.",
"....................",
".###################",
"....................",
"###################.",
"....................",
".###################",
"....................",
"###################.",
"....................",
"###################E",
    ]
  }
};

/* ========= Utilities ========= */
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
function pad2(n){ return (n<10?'0':'')+n; }
function fmtTime(s){ const m=Math.floor(s/60), ss=Math.floor(s%60); return pad2(m)+':'+pad2(ss); }

/* ========= Game State ========= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:false });
let DPR = Math.max(1, Math.min(2, devicePixelRatio || 1));

let levelName = "Serpent-15";
let N = 15;
let cellPx = 24;

let safe = [];           // [y][x] boolean
let start = {x:0,y:0};
let exitC = {x:0,y:0};
let player = {x:0,y:0};

let steps=0,deaths=0,startTime=0,timeSec=0,timerId=null;
let echoUses=3;
let assistBlink=false, assistGlowT=0;
let running=false;

const els = {
  deaths: document.getElementById('deaths'),
  steps: document.getElementById('steps'),
  time: document.getElementById('time'),
  btnReset: document.getElementById('btnReset'),
  btnMute: document.getElementById('btnMute'),
  btnMute2: document.getElementById('btnMute2'),
  btnPing: document.getElementById('btnPing'),
  assist: document.getElementById('assist'),
  startOverlay: document.getElementById('startOverlay'),
  winOverlay: document.getElementById('winOverlay'),
  sumDeaths: document.getElementById('sumDeaths'),
  sumSteps: document.getElementById('sumSteps'),
  sumTime: document.getElementById('sumTime'),
  bestLine: document.getElementById('bestLine'),
  winLevel: document.getElementById('winLevel'),
  btnReplay: document.getElementById('btnReplay'),
  btnClose: document.getElementById('btnClose'),
  btnStart: document.getElementById('btnStart'),
  btnPrint: document.getElementById('btnPrint'),
  levelSel: document.getElementById('levelSel'),
  customText: document.getElementById('customText'),
  padUp: document.getElementById('btnUp'),
  padDown: document.getElementById('btnDown'),
  padLeft: document.getElementById('btnLeft'),
  padRight: document.getElementById('btnRight'),
  padCenter: document.getElementById('btnCenter'),
  bgm: document.getElementById('bgm'),
  lose: document.getElementById('lose')
};

function resize(){
  const w=innerWidth,h=innerHeight;
  canvas.width = Math.floor(w*DPR);
  canvas.height = Math.floor(h*DPR);
  canvas.style.width = w+'px';
  canvas.style.height = h+'px';
  const maxCellW = Math.floor((canvas.width * 0.85) / N);
  const maxCellH = Math.floor((canvas.height * 0.70) / N);
  cellPx = Math.max(10, Math.min(maxCellW, maxCellH));
}
addEventListener('resize', resize);

function updateHUD(){
  els.deaths.textContent = deaths;
  els.steps.textContent = steps;
  els.time.textContent = fmtTime(timeSec);
  els.btnPing.textContent = `Echo (${echoUses})`;
}

/* ========= Level loading (fixed) ========= */
function parseGrid(lines){
  const trimmed = lines.map(s => s.replace(/\s+$/,''));
  const width = Math.max(...trimmed.map(s=>s.length));
  if(trimmed.some(s => s.length !== width)) throw new Error('All rows must have equal width');
  let sx=-1, sy=-1, ex=-1, ey=-1;
  const grid = [];
  for(let y=0;y<trimmed.length;y++){
    const row = trimmed[y];
    const arr = [];
    for(let x=0;x<width;x++){
      const ch = row[x] || '#';
      if(ch==='S'){ sx=x; sy=y; arr.push(true); }
      else if(ch==='E'){ ex=x; ey=y; arr.push(true); }
      else if(ch==='.') arr.push(true);
      else if(ch==='#') arr.push(false);
      else arr.push(false); // treat unknown as pit
    }
    grid.push(arr);
  }
  if(sx<0||sy<0) throw new Error('No start S found');
  if(ex<0||ey<0) throw new Error('No exit E found');
  return { grid, width, height: trimmed.length, start:{x:sx,y:sy}, exit:{x:ex,y:ey} };
}

function loadLevel(name){
  levelName = name;
  let lines;
  if(name === 'Custom'){
    const txt = els.customText.value.trim();
    if(!txt) throw new Error('Paste your custom grid first');
    lines = txt.split('\n');
  } else {
    lines = LEVELS[name].grid.slice();
  }
  const parsed = parseGrid(lines);
  safe = parsed.grid;
  N = parsed.width;
  start = parsed.start;
  exitC = parsed.exit;
  player = { ...start };
  steps = deaths = timeSec = 0;
  echoUses = 3;
  updateHUD();
}

/* ========= Timer ========= */
function startTimer(){
  if(timerId) clearInterval(timerId);
  startTime = Date.now();
  timerId = setInterval(()=>{ timeSec = (Date.now()-startTime)/1000; els.time.textContent = fmtTime(timeSec); }, 250);
}

/* ========= Render ========= */
function render(){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const totalW = N*cellPx, totalH = safe.length*cellPx;
  const offX = Math.floor((canvas.width - totalW)/2);
  const offY = Math.floor((canvas.height - totalH)/2);

  // faint exit pulse (still very subtle)
  const t = performance.now()/1000;
  const pulse = (Math.sin(t*2)+1)/2 * .35 + .1;
  ctx.strokeStyle = `rgba(255,255,255,${pulse*0.12})`;
  ctx.lineWidth = Math.max(1, Math.floor(cellPx*0.06));
  const ex = offX + (exitC.x+0.5)*cellPx, ey = offY + (exitC.y+0.5)*cellPx;
  ctx.beginPath(); ctx.arc(ex, ey, cellPx*0.45, 0, Math.PI*2); ctx.stroke();

  // Assist blink on player tile
  if(els.assist.checked && assistGlowT>0){
    const a = Math.max(0, Math.min(1, assistGlowT/200));
    ctx.fillStyle = `rgba(255,255,255,${0.08*a})`;
    ctx.fillRect(offX + player.x*cellPx, offY + player.y*cellPx, cellPx, cellPx);
    assistGlowT -= 16;
  }

  // Player
  ctx.fillStyle='#fff';
  const px = offX + (player.x+0.5)*cellPx, py = offY + (player.y+0.5)*cellPx;
  ctx.beginPath(); ctx.arc(px, py, Math.max(2, cellPx*0.22), 0, Math.PI*2); ctx.fill();

  requestAnimationFrame(render);
}

/* ========= Rules ========= */
function lose(){
  deaths++; updateHUD();
  document.body.classList.add('flash-red'); setTimeout(()=>document.body.classList.remove('flash-red'), 180);
  try{ els.lose.currentTime=0; els.lose.play().catch(()=>{});}catch{}
  if(navigator.vibrate) navigator.vibrate([80,40,80]);
  player = { ...start };
}

function checkWin(){
  if(player.x===exitC.x && player.y===exitC.y){
    running=false; if(timerId){clearInterval(timerId); timerId=null;}
    const key = `BFM_FIXED_${levelName}`;
    const prev = JSON.parse(localStorage.getItem(key) || 'null');
    const cur = { deaths, time: timeSec, steps };
    let bestStr = '‚Äî';
    if(!prev || cur.deaths < prev.deaths || (cur.deaths===prev.deaths && cur.time < prev.time)){
      localStorage.setItem(key, JSON.stringify(cur));
      bestStr = `new best! üéØ deaths ${cur.deaths}, time ${fmtTime(cur.time)}`;
    } else {
      bestStr = `best stays: deaths ${prev.deaths}, time ${fmtTime(prev.time)}`;
    }
    document.getElementById('winLevel').textContent = levelName;
    document.getElementById('sumDeaths').textContent = deaths;
    document.getElementById('sumSteps').textContent = steps;
    document.getElementById('sumTime').textContent = fmtTime(timeSec);
    document.getElementById('bestLine').textContent = bestStr;
    els.winOverlay.style.display='flex';
    fadeBgm(0.3, 300);
  }
}

function move(dx,dy){
  if(!running) return;
  const nx = clamp(player.x+dx, 0, N-1);
  const ny = clamp(player.y+dy, 0, safe.length-1);
  if(nx===player.x && ny===player.y) return;
  steps++; player.x=nx; player.y=ny;
  if(els.assist.checked){ assistBlink=true; assistGlowT=220; }
  updateHUD();
  if(!safe[ny][nx]){ lose(); return; }
  checkWin();
}

/* ========= Echo sonar ========= */
let audioCtx=null;
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function nearestPitDistance(x,y,R){
  let best=R+1;
  for(let dy=-R;dy<=R;dy++){
    for(let dx=-R;dx<=R;dx++){
      const nx=x+dx, ny=y+dy;
      if(ny<0||ny>=safe.length||nx<0||nx>=N) continue;
      if(!safe[ny][nx]){ const d=Math.abs(dx)+Math.abs(dy); if(d<best) best=d; }
    }
  }
  return best===R+1?R:best;
}
function echoPing(){
  if(!running || echoUses<=0) return;
  echoUses--; updateHUD();
  ensureAudioCtx();
  const d = nearestPitDistance(player.x, player.y, 5);
  const freq = 220 + (5 - d) * 90;
  const dur  = 0.12 + (5 - d) * 0.02;
  const gain = audioCtx.createGain();
  const osc = audioCtx.createOscillator();
  osc.type='sine'; osc.frequency.value=freq;
  gain.gain.value=0.0001; osc.connect(gain).connect(audioCtx.destination);
  const now=audioCtx.currentTime; osc.start();
  gain.gain.exponentialRampToValueAtTime(0.08, now+0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, now+dur);
  osc.stop(now+dur+0.02);
  if(navigator.vibrate) navigator.vibrate(25);
  assistBlink=true; assistGlowT=120;
}

/* ========= Input ========= */
function bindPad(btn,dx,dy){
  let hold=null; const go=()=>move(dx,dy);
  btn.addEventListener('touchstart',e=>{e.preventDefault();go();hold=setInterval(go,160);});
  btn.addEventListener('mousedown',e=>{e.preventDefault();go();hold=setInterval(go,160);});
  const stop=()=>{if(hold){clearInterval(hold);hold=null;}}
  btn.addEventListener('touchend',stop);btn.addEventListener('touchcancel',stop);
  btn.addEventListener('mouseup',stop);btn.addEventListener('mouseleave',stop);
}
bindPad(els.padUp,0,-1); bindPad(els.padDown,0,1); bindPad(els.padLeft,-1,0); bindPad(els.padRight,1,0);

// Center: long-press Echo
(function(){
  let timer=null;
  const down=e=>{e.preventDefault();timer=setTimeout(()=>{echoPing();timer=null;},350);}
  const up=()=>{if(timer){clearTimeout(timer);timer=null;}}
  ['touchstart','mousedown'].forEach(ev=>els.padCenter.addEventListener(ev,down));
  ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>els.padCenter.addEventListener(ev,up));
})();

// Swipe
let touchStart=null;
canvas.addEventListener('touchstart',e=>{
  if(!running) return; const t=e.changedTouches[0];
  touchStart={x:t.clientX,y:t.clientY};
});
canvas.addEventListener('touchend',e=>{
  if(!running||!touchStart) return;
  const t=e.changedTouches[0]; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y;
  const adx=Math.abs(dx), ady=Math.abs(dy);
  if(Math.max(adx,ady)>24){ if(adx>ady) move(dx>0?1:-1,0); else move(0,dy>0?1:-1); }
  touchStart=null;
});

// Keyboard
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(['arrowup','w'].includes(k)){move(0,-1);e.preventDefault();}
  else if(['arrowdown','s'].includes(k)){move(0,1);e.preventDefault();}
  else if(['arrowleft','a'].includes(k)){move(-1,0);e.preventDefault();}
  else if(['arrowright','d'].includes(k)){move(1,0);e.preventDefault();}
  else if(k===' '){echoPing();e.preventDefault();}
});

/* ========= Audio ========= */
let muted=false;
function fadeBgm(target=0.7,ms=300){
  const a=els.bgm, start=a.volume, t0=performance.now();
  function step(){ const p=clamp((performance.now()-t0)/ms,0,1); a.volume=start+(target-start)*p; if(p<1) requestAnimationFrame(step); }
  requestAnimationFrame(step);
}
function startBgm(){
  if(muted) return;
  els.bgm.volume=0;
  els.bgm.play().then(()=>fadeBgm(0.6,500)).catch(()=>{ /* user gesture needed */ });
}
function toggleMute(){
  muted=!muted; els.bgm.muted=muted; els.lose.muted=muted;
  els.btnMute.textContent = muted?'üîá':'üîä';
  els.btnMute2.textContent = els.btnMute.textContent;
}

/* ========= Start/Reset/Print ========= */
function startRun(){
  try{
    loadLevel(els.levelSel.value);
  }catch(err){
    alert(err.message); return;
  }
  resize(); running=true; timeSec=0; updateHUD(); startTimer();
  els.startOverlay.style.display='none'; els.winOverlay.style.display='none'; startBgm();
}
function resetRun(){
  // reload same level
  loadLevel(levelName);
  timeSec=0; startTime=Date.now(); updateHUD();
  if(!muted) fadeBgm(0.6,150);
}
function printGrid(){
  const H = safe.length, W = N;
  const html = `
  <!doctype html><html><head><meta charset="utf-8"><title>Grid ${W}√ó${H}</title>
  <style>
    body{margin:20px;font-family:system-ui} h1{font-size:16px;margin:0 0 10px}
    table{border-collapse:collapse} td{width:22px;height:22px;border:1px solid #444}
    @media print { body{margin:0} td{width:18px;height:18px} }
  </style></head><body>
  <h1>Blind Fault Maze ‚Äî ${W}√ó${H} (level: ${levelName})</h1>
  <table>
    ${Array.from({length:H},()=>'<tr>'+Array.from({length:W},()=>'<td></td>').join('')+'</tr>').join('')}
  </table></body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}

/* ========= Buttons ========= */
els.btnStart.addEventListener('click', startRun);
els.btnReset.addEventListener('click', resetRun);
els.btnPrint.addEventListener('click', printGrid);
els.btnPing.addEventListener('click', echoPing);
els.btnMute.addEventListener('click', toggleMute);
els.btnMute2.addEventListener('click', toggleMute);
els.btnReplay.addEventListener('click', ()=>{ els.winOverlay.style.display='none'; startRun(); });
els.btnClose.addEventListener('click', ()=>{ els.winOverlay.style.display='none'; els.startOverlay.style.display='flex'; fadeBgm(0.3, 150); });

/* ========= Boot ========= */
resize(); render();
</script>
</body>
</html>
