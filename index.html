<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üó∫Ô∏è –ü—É—Ç—å –í–µ—Ä—ã ‚Äî –ö–ª–∞—Å—Å–Ω–∞—è –ò–≥—Ä–∞</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<style>
  :root{
    --hud-h: 56px;
    --sidebar-w: 320px;
    --board-cols: 12;                    /* 12 x 10 = 120 –∫–ª–µ—Ç–æ–∫ */
    --board-rows: 10;
    --cell-size: 60px;                   /* –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è JS */
    --cell-gap: 8px;
  }
  html,body{height:100%; margin:0; background:#efe9d9; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
  /* Layout: top bar + board + sidebar */
  .app{
    display:grid;
    grid-template-rows: var(--hud-h) 1fr;
    grid-template-columns: 1fr var(--sidebar-w);
    height:100vh;
  }
  .topbar{
    grid-column:1 / span 2;
    display:flex; align-items:center; gap:10px; padding:8px 12px;
    background:rgba(255,255,255,.9); backdrop-filter:saturate(1.4) blur(6px);
    border-bottom:1px solid #eadfcf;
  }
  .brand{font-weight:800}

  .stage{
    position:relative;
    background: radial-gradient(1200px 800px at 20% -10%, #fff, #f7f5ef 60%, #ece7d8);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .board{
    position:relative;
    display:grid;
    grid-template-columns: repeat(var(--board-cols), var(--cell-size));
    grid-template-rows: repeat(var(--board-rows), var(--cell-size));
    gap: var(--cell-gap);
    padding: 12px;
    border-radius: 18px;
    background:#fff url('./assets/bg_map.jpg') center/cover no-repeat;
    box-shadow:0 12px 30px rgba(0,0,0,.12);
    max-width: 100%;
    max-height: 100%;
  }
  .cell{
    position:relative; border-radius:12px; background:#faf8f2dd;
    border:2px solid #e7dfcc; backdrop-filter:saturate(1.2) blur(1px);
    display:flex; align-items:center; justify-content:center; text-align:center;
    padding:6px; font-weight:600; font-size:12px; line-height:1.1;
    user-select:none; transition:transform .12s ease;
  }
  .cell:hover{transform:translateY(-2px)}
  .cell .idx{position:absolute; top:4px; left:6px; font-size:10px; opacity:.45}
  /* Only colored chips (no text labels on tiles) */
  .badge-chip{font-size:10px; color:#fff; display:inline-block; padding:2px 6px; border-radius:999px}
  .chip-quiz{background:#f59e0b}
  .chip-bless{background:#10b981}
  .chip-chal{background:#ef4444}
  .cell.type-start{border-color:#b0d7a6}
  .cell.type-finish{border-color:#b5a6d7}

  /* Pawns */
  .pawn{
    position:absolute; width:30px;height:30px;border-radius:50%;
    border:2px solid #111; box-shadow:0 4px 10px rgba(0,0,0,.2); transform:translate(-50%,-50%);
    background-size:cover; background-position:center; background-color:#ddd;
  }
  .pawn.red{background-image:url('./assets/pawn_red.png')}
  .pawn.blue{background-image:url('./assets/pawn_blue.png')}

  /* Sidebar */
  .sidebar{
    background:#fff; border-left:1px solid #eadfcf; padding:12px; display:flex; flex-direction:column; gap:12px;
  }
  .side-card{border:1px solid #eadfcf; border-radius:12px; padding:12px; background:#fff}
  .dice-box{display:flex;flex-direction:column;align-items:center;gap:10px}
  .turn-name{font-weight:800; text-align:center}
  .dice{
    width:64px;height:64px;border-radius:12px;border:2px solid #e2e8f0;
    display:flex;align-items:center;justify-content:center;font-size:32px;background:#fff;
    box-shadow: inset 0 2px 0 rgba(0,0,0,.05);
  }
  .btn-wide{width:100%}
  .notes{min-height:120px; font-size:15px}

  /* Big event modal */
  .modal-backdrop-custom{
    position:fixed; inset:0; background:rgba(20,16,5,.6);
    display:none; align-items:center; justify-content:center; z-index:60;
  }
  .modal-backdrop-custom.show{display:flex}
  .modal-card{
    max-width:920px; width:calc(100% - 28px); background:#fff; border-radius:22px; padding:22px;
    box-shadow:0 20px 60px rgba(0,0,0,.25); border:1px solid #eadfcf;
  }
  .answer{border:1px solid #e5e7eb; border-radius:10px; padding:12px; cursor:pointer; background:#fff}
  .answer:hover{background:#f7fafc}
  .answer.correct{border-color:#10b981; background:#ecfdf5}
  .answer.wrong{border-color:#ef4444; background:#fef2f2}

  /* Full-screen dice overlay */
  .dice-overlay{
    position:fixed; inset:0; z-index:70; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
  }
  .dice-overlay.show{display:flex}
  .big-die{
    width:min(40vh,40vw); height:min(40vh,40vw);
    border-radius:24px; background:#fff; border:6px solid #222;
    display:flex; align-items:center; justify-content:center; font-size:min(22vh,22vw);
    box-shadow:0 20px 80px rgba(0,0,0,.45);
    animation:diePop .6s ease forwards;
  }
  @keyframes diePop{
    0%{transform:scale(.6) rotate(-10deg); opacity:.2}
    50%{transform:scale(1.08) rotate(8deg); opacity:1}
    100%{transform:scale(1) rotate(0)}
  }

  /* Setup (2 teams) */
  .setup{
    position:fixed; inset:0; background:linear-gradient(180deg,#fff,#f3eee0);
    display:flex; align-items:center; justify-content:center; z-index:80; padding:18px;
  }
  .setup-card{max-width:760px; width:100%; background:#fff; border:1px solid #eadfcf; border-radius:18px; padding:16px}
</style>
</head>
<body>

<div class="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">üó∫Ô∏è –ü—É—Ç—å –í–µ—Ä—ã</div>
  </div>

  <!-- Board -->
  <div class="stage">
    <section id="board" class="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></section>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-card text-center">
      <div class="turn-name" id="turnName">‚Äî</div>
    </div>

    <div class="side-card dice-box">
      <div id="dice" class="dice" title="–ö—É–±–∏–∫">üé≤</div>
      <button id="rollBtn" class="btn btn-success btn-wide">–ë—Ä–æ—Å–∏—Ç—å</button>
      <div class="d-grid gap-2">
        <button id="skipTurnBtn" class="btn btn-outline-secondary">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥</button>
        <button id="fsBtn" class="btn btn-outline-secondary">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
        <button id="musicBtn" class="btn btn-outline-primary">–ú—É–∑—ã–∫–∞ ‚ñ∂Ô∏è</button>
        <button id="endBtn" class="btn btn-outline-danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
    </div>

    <div class="side-card">
      <div class="d-flex align-items-center gap-2 mb-1">
        <img src="./assets/icon_scroll.jpeg" onerror="this.style.display='none'" alt="" width="18" height="18">
        <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</strong>
      </div>
      <div id="sideNotes" class="notes small">–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª, –∑–∞—Ç–µ–º ¬´–ë—Ä–æ—Å–∏—Ç—å¬ª.</div>
    </div>
  </aside>
</div>

<!-- Big Dice Overlay -->
<div id="diceOverlay" class="dice-overlay" aria-hidden="true">
  <div id="bigDie" class="big-die">‚öÑ</div>
</div>

<!-- Setup (2 –∫–æ–º–∞–Ω–¥—ã) -->
<section id="setup" class="setup" aria-modal="true" aria-hidden="false">
  <div class="setup-card">
    <h1 class="h4 mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Ç–∏–∏ (2 –∫–æ–º–∞–Ω–¥—ã)</h1>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ 1 (–∫—Ä–∞—Å–Ω—ã–µ)</label>
        <input id="name1" class="form-control" value="–ö—Ä–∞—Å–Ω—ã–µ">
      </div>
      <div class="col-md-6">
        <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ 2 (—Å–∏–Ω–∏–µ)</label>
        <input id="name2" class="form-control" value="–°–∏–Ω–∏–µ">
      </div>
      <div class="col-12 d-flex gap-2">
        <button id="startBtn" class="btn btn-primary px-4">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="fsBtnSetup" class="btn btn-outline-secondary">–í–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
        <span class="text-muted d-none d-sm-inline">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã.</span>
      </div>
    </div>
  </div>
</section>

<!-- Modal -->
<div id="modal" class="modal-backdrop-custom" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <div class="d-flex justify-content-between align-items-start">
      <h3 id="modalTitle" class="h4 mb-2">‚Äî</h3>
      <button id="modalClose" class="btn btn-sm btn-outline-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="modalBody" class="mt-2"></div>
    <div id="modalFooter" class="mt-3 d-flex gap-2 justify-content-end"></div>
  </div>
</div>

<!-- Sounds + Music -->
<audio id="sfxDice" src="./assets/sfx_dice.wav" preload="auto"></audio>
<audio id="sfxMove" src="./assets/sfx_move.wav" preload="auto"></audio>
<audio id="sfxCorrect" src="./assets/sfx_correct.wav" preload="auto"></audio>
<audio id="sfxWrong" src="./assets/sfx_wrong.wav" preload="auto"></audio>
<audio id="sfxBless" src="./assets/sfx_blessing.wav" preload="auto"></audio>
<audio id="sfxChal" src="./assets/sfx_challenge.wav" preload="auto"></audio>
<audio id="sfxWin" src="./assets/sfx_win.wav" preload="auto"></audio>
<audio id="bgm" src="./assets/music_bg.mp3" preload="auto" loop></audio>

<script>
(()=>{
  // ---------- Board settings ----------
  const BOARD_COLS = 12;
  const BOARD_ROWS = 10;
  const TILE_COUNT = BOARD_COLS * BOARD_ROWS; // 120

  // ---------- Specials (NO STORIES) ----------
  function buildSpecials(){
    const S = {};
    S[1] = {type:'start'};
    S[TILE_COUNT] = {type:'finish'};
    // quizzes / blessings / challenges scattered; lots of empty tiles
    [10,12,18,24,28,33,36,42,48,52,55,58,63,66,69,73,76,83,88,94,97,101,104,108,112,116].forEach(i=>{ if(i<TILE_COUNT) S[i]={type:'quiz'}; });
    [8,14,22,30,38,46,54,62,70,78,86,95,103,111,118].forEach(i=>{ if(i<TILE_COUNT) S[i]={type:'bless'}; });
    [9,16,26,34,44,50,56,64,72,82,90,98,106,114].forEach(i=>{ if(i<TILE_COUNT) S[i]={type:'chal'}; });
    return S;
  }
  const SPECIALS = buildSpecials();

  // ---------- Helpers ----------
  function $(q,scope=document){ return scope.querySelector(q); }
  function ce(tag, cls, html){ const n=document.createElement(tag); if(cls) n.className=cls; if(html!=null) n.innerHTML=html; return n; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  // ---------- A/B DECKS ----------
  function q(question, options, answerIndex, ref){ return {question, options, answerIndex, ref}; }

  // QUIZ: A for leader/equal, B for behind
  const QUIZ_A = shuffle([
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö —Å—ã–Ω–æ–≤–µ–π –ê–¥–∞–º–∞ –∏ –ï–≤—ã?', ['–ö–∞–∏–Ω –∏ –ê–≤–µ–ª—å','–î–∞–≤–∏–¥ –∏ –ò–æ–Ω–∞—Ñ–∞–Ω','–ü—ë—Ç—Ä –∏ –ê–Ω–¥—Ä–µ–π'], 0, '–ë—ã—Ç. 4:1‚Äì2'),
    q('–ì–¥–µ –∂–∏–ª–∞ –ø–µ—Ä–≤–∞—è —Å–µ–º—å—è?', ['–≠–¥–µ–º','–ò–µ—Ä—É—Å–∞–ª–∏–º','–ù–∞–∑–∞—Ä–µ—Ç'], 0, '–ë—ã—Ç. 2'),
    q('–ö—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –∫–æ–≤—á–µ–≥?', ['–ù–æ–π','–ú–æ–∏—Å–µ–π','–ê–≤—Ä–∞–∞–º'], 0, '–ë—ã—Ç. 6‚Äì9'),
    q('–ö–∞–∫–æ–π –∑–Ω–∞–∫ –ë–æ–≥ –¥–∞–ª –ø–æ—Å–ª–µ –ø–æ—Ç–æ–ø–∞?', ['–†–∞–¥—É–≥–∞','–û–≥–æ–Ω—å','–°–∫–∏–Ω–∏—è'], 0, '–ë—ã—Ç. 9:13'),
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ —Å—ã–Ω–æ–≤–µ–π –ù–æ—è?', ['–°–∏–º, –•–∞–º, –ò–∞—Ñ–µ—Ç','–ö–∞–∏–Ω, –ê–≤–µ–ª—å, –°–∏—Ñ','–ü—ë—Ç—Ä, –ò–∞–∫–æ–≤, –ò–æ–∞–Ω–Ω'], 0, '–ë—ã—Ç. 5‚Äì10'),
    q('–ò–º—è —Å—ã–Ω–∞ –æ–±–µ—Ç–æ–≤–∞–Ω–∏—è –ê–≤—Ä–∞–∞–º–∞ –∏ –°–∞—Ä—ã:', ['–ò—Å–∞–∞–∫','–ò—à–º–∞–∏–ª','–ï—Å–∞—É'], 0, '–ë—ã—Ç. 21'),
    q('–î—Ä—É–≥–æ–µ –∏–º—è –ò–∞–∫–æ–≤–∞ ‚Äî —ç—Ç–æ‚Ä¶', ['–ò–∑—Ä–∞–∏–ª—å','–ò—Å–∞–≤','–ò—É–¥–∞'], 0, '–ë—ã—Ç. 32:28'),
    q('–°–∫–æ–ª—å–∫–æ —Å—ã–Ω–æ–≤–µ–π —É –ò–∞–∫–æ–≤–∞?', ['12','10','7'], 0, '–ë—ã—Ç. 35:22‚Äì26'),
    q('–ö—Ç–æ –≤—ã–≤–µ–ª –ò–∑—Ä–∞–∏–ª—å –∏–∑ –ï–≥–∏–ø—Ç–∞?', ['–ú–æ–∏—Å–µ–π','–ò–∏—Å—É—Å –ù–∞–≤–∏–Ω','–°–∞–º—É–∏–ª'], 0, '–ò—Å—Ö. 12‚Äì14'),
    q('–ù–∞ –∫–∞–∫–æ–π –≥–æ—Ä–µ –¥–∞–Ω—ã –∑–∞–ø–æ–≤–µ–¥–∏?', ['–°–∏–Ω–∞–π','–ö–∞—Ä–º–∏–ª','–ì–æ–ª–≥–æ—Ñ–∞'], 0, '–ò—Å—Ö. 19‚Äì20'),
    q('–ö—Ç–æ —Ä–æ–¥–∏–ª—Å—è –≤ –í–∏—Ñ–ª–µ–µ–º–µ?', ['–ò–∏—Å—É—Å','–ú–æ–∏—Å–µ–π','–ò–æ–∞–Ω–Ω'], 0, '–ú—Ñ. 2'),
    q('–ö—Ç–æ –≥–ª–∞–≤–∞ –¶–µ—Ä–∫–≤–∏?', ['–•—Ä–∏—Å—Ç–æ—Å','–ü—ë—Ç—Ä','–ú–æ–∏—Å–µ–π'], 0, '–ï—Ñ. 1:22'),
  ]);
  const QUIZ_B = shuffle([
    q('–ö–æ–≥–æ –ë–æ–≥ –¥–∞–ª –≤–º–µ—Å—Ç–æ –ê–≤–µ–ª—è?', ['–°–∏—Ñ–∞','–°–∏–º–∞','–°–∞—É–ª–∞'], 0, '–ë—ã—Ç. 4:25'),
    q('–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —à—ë–ª –¥–æ–∂–¥—å –≤–æ –≤—Ä–µ–º—è –ø–æ—Ç–æ–ø–∞?', ['40','7','3'], 0, '–ë—ã—Ç. 7:12'),
    q('–ò–∑ –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω—ã –ë–æ–≥ –ø–æ–∑–≤–∞–ª –ê–≤—Ä–∞–∞–º–∞?', ['–£—Ä –•–∞–ª–¥–µ–π—Å–∫–∏–π','–ï–≥–∏–ø–µ—Ç','–°–∏–¥–æ–Ω'], 0, '–ë—ã—Ç. 11:31'),
    q('–ö–∞–∫ –∑–≤–∞–ª–∏ –ø–ª–µ–º—è–Ω–Ω–∏–∫–∞ –ê–≤—Ä–∞–∞–º–∞?', ['–õ–æ—Ç','–ò–æ–≤','–°–∞–º—Å–æ–Ω'], 0, '–ë—ã—Ç. 12‚Äì19'),
    q('–ö—Ç–æ –ø—Ä–æ–¥–∞–ª –ò–æ—Å–∏—Ñ–∞ –≤ –ï–≥–∏–ø–µ—Ç?', ['–ë—Ä–∞—Ç—å—è','–§–∏–ª–∏—Å—Ç–∏–º–ª—è–Ω–µ','–ú–æ–∞–≤–∏—Ç—è–Ω–µ'], 0, '–ë—ã—Ç. 37'),
    q('–°–∫–æ–ª—å–∫–æ –∑–∞–ø–æ–≤–µ–¥–µ–π –Ω–∞ —Å–∫—Ä–∏–∂–∞–ª—è—Ö?', ['10','7','12'], 0, '–ò—Å—Ö. 20'),
    q('–ö—Ç–æ –±—ã–ª –ø–∞—Å—Ç—É—Ö–æ–º –∏ —Å—Ç–∞–ª —Ü–∞—Ä—ë–º?', ['–î–∞–≤–∏–¥','–°–∞—É–ª','–°–æ–ª–æ–º–æ–Ω'], 0, '1 –¶–∞—Ä. 16'),
    q('–ö—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –ø–µ—Ä–≤—ã–π —Ö—Ä–∞–º?', ['–°–æ–ª–æ–º–æ–Ω','–î–∞–≤–∏–¥','–ò–ª–∏—è'], 0, '3 –¶–∞—Ä. 6'),
    q('–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –ü—è—Ç–∏–¥–µ—Å—è—Ç–Ω–∏—Ü—É?', ['–°–æ—à—ë–ª –°–≤—è—Ç–æ–π –î—É—Ö','–†–∞–∑—Ä—É—à–∏–ª—Å—è —Ö—Ä–∞–º','–°–æ—à–ª–∞ –º–∞–Ω–Ω–∞'], 0, '–î–µ—è–Ω. 2'),
    q('–ß—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ö—Ä–∏—Å—Ç–∏–∞–Ω –∫–∞–∫ —Å–µ–º—å—é?', ['–í–µ—Ä–∞ –≤–æ –•—Ä–∏—Å—Ç–∞','–û–¥–∏–Ω —è–∑—ã–∫','–û–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'], 0, '–ì–∞–ª. 3:26‚Äì28'),
    q('–ì–¥–µ –≤—ã—Ä–æ—Å –ò–∏—Å—É—Å?', ['–ù–∞–∑–∞—Ä–µ—Ç','–í–∏—Ñ–ª–µ–µ–º','–ò–µ—Ä–∏—Ö–æ–Ω'], 0, '–õ–∫. 2'),
    q('–ö–æ–≥–æ –ø—Ä–æ–∑–≤–∞–ª–∏ ¬´—Å—ã–Ω–∞–º–∏ –≥—Ä–æ–º–∞¬ª?', ['–ò–∞–∫–æ–≤–∞ –∏ –ò–æ–∞–Ω–Ω–∞','–ü–µ—Ç—Ä–∞ –∏ –ê–Ω–¥—Ä–µ—è','–§–æ–º—É –∏ –§–∏–ª–∏–ø–ø–∞'], 0, '–ú–∫. 3:17'),
  ]);

  // BLESSINGS (A/B different vibes)
  const BLESS_A = shuffle([
    ['–û–±–æ–¥—Ä–µ–Ω–∏–µ','–°–∫–∞–∂–∏—Ç–µ, –∑–∞ —á—Ç–æ –≤—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –≤ —Å–µ–º—å–µ. +1 —à–∞–≥.'],
    ['–ï–¥–∏–Ω—Å—Ç–≤–æ','¬´–ú—ã ‚Äî –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞!¬ª. +1 —à–∞–≥.'],
    ['–ü–æ–¥–¥–µ—Ä–∂–∫–∞','–ö–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –¥—Ä—É–≥–∞ –≤ –∫–ª–∞—Å—Å–µ? +2 —à–∞–≥–∞.'],
    ['–î–æ–±—Ä—ã–µ —Å–ª–æ–≤–∞','–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –Ω–∞–ø–∞—Ä–Ω–∏–∫—É. +1 —à–∞–≥.'],
  ]);
  const BLESS_B = shuffle([
    ['–ù–∞–¥–µ–∂–¥–∞','–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –±–∏–±–ª–µ–π—Å–∫–∏–º –æ–±–µ—â–∞–Ω–∏–µ–º. +1 —à–∞–≥.'],
    ['–°–ª—É–∂–µ–Ω–∏–µ','–ù–∞–∑–æ–≤–∏—Ç–µ, –∫–∞–∫ –ø–æ–º–æ–∂–µ—Ç–µ –¥–æ–º–∞. +2 —à–∞–≥–∞.'],
    ['–†–∞–¥–æ—Å—Ç—å','–ù–∞–∑–æ–≤–∏—Ç–µ —Ö–æ—Ä–æ—à–µ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–µ–¥–µ–ª–∏. +1 —à–∞–≥.'],
    ['–í–Ω–∏–º–∞–Ω–∏–µ','5 —Å–µ–∫—É–Ω–¥ —Ç–∏—à–∏–Ω—ã –∏ —É–ª—ã–±–∫–∞ –∫–æ–º–∞–Ω–¥–µ. +1 —à–∞–≥.'],
  ]);

  // INTERACTIVE CHALLENGES (relationship-first)
  // effect: 'continue' | 'give5' | 'opp2' | 'skipSelf'
  const CHAL_A = shuffle([
    {t:'–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç —Å–æ–ø–µ—Ä–Ω–∏–∫—É','d':'–ù–∞–∑–æ–≤–∏—Ç–µ —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–∞ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã.',effect:'continue'},
    {t:'–©–µ–¥—Ä–æ—Å—Ç—å: +5 –∫–ª–µ—Ç–æ–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫—É','d':'–ü–æ–∂–µ—Ä—Ç–≤—É–π—Ç–µ 5 –∫–ª–µ—Ç–æ–∫ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥–µ (–æ–Ω–∏ –ø—Ä–æ–π–¥—É—Ç —Å —Å–æ–±—ã—Ç–∏—è–º–∏).',effect:'give5'},
    {t:'–ü–æ–¥–∞—Ä–æ–∫: 2 –±—Ä–æ—Å–∫–∞','d':'–ü–æ–¥–∞—Ä–∏—Ç–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞–º 2 –±—Ä–æ—Å–∫–∞ –ø–æ–¥—Ä—è–¥ –Ω–∞ –∏—Ö —Å–ª–µ–¥—É—é—â–µ–º —Ö–æ–¥—É.',effect:'opp2'},
    {t:'–£—Å—Ç—É–ø–∏—Ç—å —Ö–æ–¥','d':'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥ —Ä–∞–¥–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤.',effect:'skipSelf'},
    {t:'–ü–æ–¥–¥–µ—Ä–∂–∫–∞','d':'–°–∫–∞–∂–∏—Ç–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞–º —Å–ª–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏.',effect:'continue'},
    {t:'–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü','d':'–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –º–∏—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ª—é–±–æ–≥–æ —Å–ø–æ—Ä–∞.',effect:'continue'},
  ]);
  const CHAL_B = shuffle([
    {t:'–°–ª—É–∂–µ–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫—É','d':'–°–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ –º–æ–≥–ª–∏ –±—ã –ø–æ—Å–ª—É–∂–∏—Ç—å –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥–µ.',effect:'continue'},
    {t:'–©–µ–¥—Ä–æ—Å—Ç—å: +5 –∫–ª–µ—Ç–æ–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫—É','d':'–ü–æ–∂–µ—Ä—Ç–≤—É–π—Ç–µ 5 –∫–ª–µ—Ç–æ–∫ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥–µ (–æ–Ω–∏ –ø—Ä–æ–π–¥—É—Ç —Å —Å–æ–±—ã—Ç–∏—è–º–∏).',effect:'give5'},
    {t:'–ü–æ–¥–∞—Ä–æ–∫: 2 –±—Ä–æ—Å–∫–∞','d':'–ü–æ–¥–∞—Ä–∏—Ç–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞–º 2 –±—Ä–æ—Å–∫–∞ –ø–æ–¥—Ä—è–¥ –Ω–∞ –∏—Ö —Å–ª–µ–¥—É—é—â–µ–º —Ö–æ–¥—É.',effect:'opp2'},
    {t:'–£—Å—Ç—É–ø–∏—Ç—å —Ö–æ–¥','d':'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥ —Ä–∞–¥–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤.',effect:'skipSelf'},
    {t:'–ü—Ä–æ—â–µ–Ω–∏–µ','d':'–ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –º–µ–ª–æ—á—å.',effect:'continue'},
    {t:'–†–∞–¥–æ—Å—Ç—å –∑–∞ –¥—Ä—É–≥–∏—Ö','d':'–ò—Å–∫—Ä–µ–Ω–Ω–µ –ø–æ—Ä–∞–¥—É–π—Ç–µ—Å—å —É—Å–ø–µ—Ö–∞–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤.',effect:'continue'},
  ]);

  // ---------- State ----------
  let players = []; // {id,name,color,position,skipTurns,extraRolls}
  let current = 0;
  let gameStarted = false;
  let gameOver = false;
  let traversing = false;
  let modalOpen = false;
  let musicOn = false;

  // ---------- DOM ----------
  const el = {
    board: $('#board'),
    setup: $('#setup'),
    startBtn: $('#startBtn'),
    name1: $('#name1'),
    name2: $('#name2'),
    turnName: $('#turnName'),
    sideNotes: $('#sideNotes'),
    rollBtn: $('#rollBtn'),
    skipTurnBtn: $('#skipTurnBtn'),
    dice: $('#dice'),
    fsBtn: $('#fsBtn'),
    fsBtnSetup: $('#fsBtnSetup'),
    musicBtn: $('#musicBtn'),
    endBtn: $('#endBtn'),
    modal: $('#modal'),
    modalTitle: $('#modalTitle'),
    modalBody: $('#modalBody'),
    modalFooter: $('#modalFooter'),
    modalClose: $('#modalClose'),
    diceOverlay: $('#diceOverlay'),
    bigDie: $('#bigDie'),
    sfxDice: $('#sfxDice'),
    sfxMove: $('#sfxMove'),
    sfxCorrect: $('#sfxCorrect'),
    sfxWrong: $('#sfxWrong'),
    sfxBless: $('#sfxBless'),
    sfxChal: $('#sfxChal'),
    sfxWin: $('#sfxWin'),
    bgm: $('#bgm'),
  };

  // ---------- Fit board ----------
  function fitBoard(){
    const stage = document.querySelector('.stage').getBoundingClientRect();
    const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-gap')) || 8;
    const pad = 24;
    const cols = BOARD_COLS, rows = BOARD_ROWS;
    const sizeW = Math.floor((stage.width - pad - (cols-1)*gap) / cols);
    const sizeH = Math.floor((stage.height - pad - (rows-1)*gap) / rows);
    const size = Math.max(28, Math.min(sizeW, sizeH));
    document.documentElement.style.setProperty('--cell-size', size+'px');
  }
  window.addEventListener('resize', ()=>{ fitBoard(); placePawns(); });

  // ---------- Build board ----------
  function serpentineIndexToGrid(i){
    const zero = i-1;
    const r = Math.floor(zero / BOARD_COLS);
    const c = zero % BOARD_COLS;
    const row = BOARD_ROWS - 1 - r;
    const col = (r % 2 === 0) ? c : (BOARD_COLS - 1 - c);
    return {row, col};
  }
  function badgeFor(type){
    const map = {
      quiz:   '<div class="badge-chip chip-quiz">–í–ò–ö–¢–û–†–ò–ù–ê</div>',
      bless:  '<div class="badge-chip chip-bless">–ë–õ–ê–ì–û–°–õ–û–í–ï–ù–ò–ï</div>',
      chal:   '<div class="badge-chip chip-chal">–ò–°–ü–´–¢–ê–ù–ò–ï</div>',
      start:  '<div class="badge-chip chip-chal" style="background:#6b7280">–°–¢–ê–†–¢</div>',
      finish: '<div class="badge-chip chip-chal" style="background:#6b7280">–§–ò–ù–ò–®</div>',
    };
    return map[type] || '';
  }
  function buildBoard(){
    el.board.innerHTML='';
    el.board.style.setProperty('--board-cols', BOARD_COLS);
    el.board.style.setProperty('--board-rows', BOARD_ROWS);
    for(let i=1;i<=TILE_COUNT;i++){
      const spec = SPECIALS[i];
      const div = ce('div','cell'+(spec?(' type-'+spec.type):''));
      div.dataset.index = i;
      const chip = spec ? badgeFor(spec.type) : '';
      div.innerHTML = `<span class="idx">#${i}</span>${chip}`;
      const {row,col} = serpentineIndexToGrid(i);
      div.style.gridRow = (row+1);
      div.style.gridColumn = (col+1);
      el.board.appendChild(div);
    }
    fitBoard();
  }

  // ---------- Pawns ----------
  function cellCenterPos(cellEl){
    const r = cellEl.getBoundingClientRect();
    const b = el.board.getBoundingClientRect();
    return { x: r.left - b.left + r.width/2, y: r.top - b.top + r.height/2 };
  }
  function placePawns(){
    el.board.querySelectorAll('.pawn').forEach(n=>n.remove());
    for(const p of players){
      const idx = clamp(p.position,1,TILE_COUNT);
      const cell = el.board.querySelector(`.cell[data-index="${idx}"]`);
      if(!cell) continue;
      const pos = cellCenterPos(cell);
      const pawn = ce('div', 'pawn '+p.color);
      const offset = (p.color==='red') ? {x:-10,y:-10} : {x:10,y:10};
      pawn.style.left = (pos.x + offset.x) + 'px';
      pawn.style.top  = (pos.y + offset.y) + 'px';
      pawn.title = `${p.name} @ ${idx}`;
      el.board.appendChild(pawn);
    }
  }

  // ---------- Modal ----------
  function showModal(title, html, buttons=[]){
    modalOpen = true;
    el.rollBtn.disabled = true;
    el.modalTitle.textContent = title;
    el.modalBody.innerHTML = html;
    el.modalFooter.innerHTML = '';
    buttons.forEach(b=>{
      const btn = ce('button','btn '+(b.cls||'btn-secondary'));
      btn.textContent = b.label;
      btn.addEventListener('click', b.cb || closeModal);
      el.modalFooter.appendChild(btn);
    });
    el.modal.classList.add('show');
    el.modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modalOpen = false;
    el.modal.classList.remove('show');
    el.modal.setAttribute('aria-hidden','true');
    if(gameStarted && !traversing) el.rollBtn.disabled = false;
  }

  // ---------- Dice overlay ----------
  function showBigDice(faceChar){
    el.bigDie.textContent = faceChar;
    el.diceOverlay.classList.add('show');
  }
  function hideBigDice(){ el.diceOverlay.classList.remove('show'); }

  // ---------- Turn / position helpers ----------
  function currentPlayer(){ return players[current]; }
  function otherPlayer(){ return players[(current+1)%players.length]; }
  function isBehind(p){
    const other = (p===players[0]) ? players[1] : players[0];
    return p.position < other.position;
  }
  function nextTurn(){
    if(gameOver) return;
    current = (current + 1) % players.length;
    const p = currentPlayer();
    el.turnName.textContent = p.name + (p.skipTurns>0?` (–ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ ${p.skipTurns})`:``);
    if(p.skipTurns>0){
      p.skipTurns--;
      // consume and hand to other
      current = (current + 1) % players.length;
      el.turnName.textContent = currentPlayer().name;
    }
  }

  // ---------- Movement & visiting ----------
  function moveOneStep(p, dir, cb){
    p.position += dir;
    p.position = clamp(p.position, 1, TILE_COUNT);
    placePawns();
    try{ el.sfxMove.currentTime=0; el.sfxMove.play().catch(()=>{});}catch(e){}
    setTimeout(cb, 110);
  }

  // visit tile: cb('continue'|'stop')
  function visitTile(p, idx, cbDecision){
    if(idx>=TILE_COUNT){ win(p); cbDecision('stop'); return; }
    const spec = SPECIALS[idx];
    // empty or start -> just continue
    if(!spec || spec.type==='start'){ cbDecision('continue'); return; }

    if(spec.type==='quiz'){ return handleQuiz(p, cbDecision); }
    if(spec.type==='bless'){ return handleBlessing(p, cbDecision); }
    if(spec.type==='chal'){ return handleChallenge(p, cbDecision); }
    if(spec.type==='finish'){ win(p); cbDecision('stop'); return; }
    cbDecision('continue');
  }

  // traverse p for N steps, handling every tile
  function traverse(p, stepsRemaining, done){
    if(stepsRemaining<=0){ done && done(); return; }
    moveOneStep(p, +1, ()=>{
      const here = p.position;
      visitTile(p, here, (decision)=>{
        if(decision==='stop'){ done && done(); }
        else{ traverse(p, stepsRemaining-1, done); }
      });
    });
  }

  // ---------- Roll ----------
  function roll(){
    if(!gameStarted || gameOver || traversing || modalOpen) return;
    const p = currentPlayer();
    if(p.skipTurns>0){ nextTurn(); return; }

    traversing = true;
    el.rollBtn.disabled = true;
    el.skipTurnBtn.disabled = true;

    const faces = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
    let spins = 10 + Math.floor(Math.random()*8);
    let i = 0;
    try{ el.sfxDice.currentTime=0; el.sfxDice.play().catch(()=>{});}catch(e){}
    const spinTimer = setInterval(()=>{
      const face = faces[i % 6];
      el.dice.textContent = face;
      showBigDice(face);
      i++;
      if(i>=spins){
        clearInterval(spinTimer);
        const value = 1 + Math.floor(Math.random()*6);
        const faceFinal = faces[value-1];
        el.dice.textContent = faceFinal;
        showBigDice(faceFinal);
        setTimeout(()=>{
          hideBigDice();
          const stepsToEdge = TILE_COUNT - p.position;
          const steps = Math.min(stepsToEdge, value);
          traverse(p, steps, ()=>{
            traversing = false;
            if(gameOver) return;
            // bonus rolls?
            if(p.extraRolls && p.extraRolls>0){
              p.extraRolls--;
              el.sideNotes.innerHTML = `<div class="fw-bold">–ë–æ–Ω—É—Å–Ω—ã–π –±—Ä–æ—Å–æ–∫!</div><div>${p.name} –∫–∏–¥–∞–µ—Ç –µ—â—ë —Ä–∞–∑.</div>`;
              el.rollBtn.disabled = false;
              el.skipTurnBtn.disabled = false;
              return; // same player rolls again
            }
            nextTurn();
            el.rollBtn.disabled = false;
            el.skipTurnBtn.disabled = false;
          });
        }, 420);
      }
    }, 60);
  }

  // ---------- Event handlers ----------
  function getFromDeck(p, deckA, deckB){
    const useB = isBehind(p);
    const deck = useB ? deckB : deckA;
    if(deck.length) return {card: deck.pop(), from: useB?'B':'A'};
    const alt = useB ? deckA : deckB;
    if(alt.length) return {card: alt.pop(), from: useB?'A':'B'};
    return {card:null, from:null};
  }

  function handleQuiz(p, cbDecision){
    const {card} = getFromDeck(p, QUIZ_A, QUIZ_B);
    if(!card){ cbDecision('continue'); return; }
    const optsHtml = card.options.map((opt, idx)=>(
      `<div class="answer" data-idx="${idx}">${opt}</div>`
    )).join('');
    const ref = card.ref ? `<div class="small text-muted mt-2">–ú–µ—Å—Ç–æ –ü–∏—Å–∞–Ω–∏—è: ${card.ref}</div>` : '';
    showModal('–í–ò–ö–¢–û–†–ò–ù–ê ‚ùì', `
      <div class="mb-2 fw-bold fs-5">${card.question}</div>
      <div id="answers" class="d-grid gap-2">${optsHtml}</div>
      ${ref}
      <div class="small mt-3">–í–µ—Ä–Ω–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —à–∞–≥–∏. –ù–µ–≤–µ—Ä–Ω–æ ‚Äî <strong>–æ—Å—Ç–∞–µ—Ç–µ—Å—å –∑–¥–µ—Å—å</strong>, —Ö–æ–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è.</div>
    `);
    const answers = $('#answers');
    answers.querySelectorAll('.answer').forEach(a=>{
      a.addEventListener('click', ()=>{
        const chosen = +a.dataset.idx;
        const correct = (chosen === card.answerIndex);
        if(correct){
          a.classList.add('correct');
          try{ el.sfxCorrect.currentTime=0; el.sfxCorrect.play().catch(()=>{});}catch(e){}
          el.sideNotes.innerHTML = `<div class="fw-bold">–í–µ—Ä–Ω–æ!</div><div>${card.question}</div>`;
          setTimeout(()=>{ closeModal(); cbDecision('continue'); }, 450);
        }else{
          a.classList.add('wrong');
          try{ el.sfxWrong.currentTime=0; el.sfxWrong.play().catch(()=>{});}catch(e){}
          el.sideNotes.innerHTML = `<div class="fw-bold">–ù–µ–≤–µ—Ä–Ω–æ</div><div>–ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –∫–ª–µ—Ç–∫–µ #${p.position}.</div>`;
          setTimeout(()=>{ closeModal(); cbDecision('stop'); }, 450);
        }
      }, {once:true});
    });
  }

  function handleBlessing(p, cbDecision){
    const {card} = getFromDeck(p, BLESS_A, BLESS_B) || {};
    const title = card ? card[0] : '–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ';
    const text  = card ? card[1] : '+1 —à–∞–≥.';
    try{ el.sfxBless.currentTime=0; el.sfxBless.play().catch(()=>{});}catch(e){}
    el.sideNotes.innerHTML = `<div class="fw-bold">${title}</div><div>${text}</div>`;
    showModal('–ë–õ–ê–ì–û–°–õ–û–í–ï–ù–ò–ï üïäÔ∏è', `<div class="fs-5">${title}</div><div class="mt-2">${text}</div>`, [
      {label:'–ü—Ä–∏–º–µ–Ω–∏—Ç—å', cls:'btn-success', cb: ()=>{
        closeModal();
        let extra = /\+2/.test(text) ? 2 : /\+1/.test(text) ? 1 : 0;
        if(extra>0){
          traverse(p, Math.min(extra, TILE_COUNT - p.position), ()=> cbDecision('continue'));
        }else{
          cbDecision('continue');
        }
      }}
    ]);
  }

  function handleChallenge(p, cbDecision){
    const {card} = getFromDeck(p, CHAL_A, CHAL_B) || {};
    const title = card ? card.t : '–ò—Å–ø—ã—Ç–∞–Ω–∏–µ';
    const desc  = card ? card.d : '–°–¥–µ–ª–∞–π—Ç–µ –¥–æ–±—Ä–æ–µ –¥–µ–ª–æ. –£–¥–∞–ª–æ—Å—å? ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ.';
    try{ el.sfxChal.currentTime=0; el.sfxChal.play().catch(()=>{});}catch(e){}
    el.sideNotes.innerHTML = `<div class="fw-bold">${title}</div><div>${desc}</div>`;

    // Compose buttons based on effect
    const btns = [];
    if(card){
      if(card.effect==='give5'){
        btns.push({label:'–î–∞—Ç—å +5 —Å–æ–ø–µ—Ä–Ω–∏–∫—É', cls:'btn-warning', cb: ()=>{
          closeModal();
          const opp = otherPlayer();
          traversing = true; el.rollBtn.disabled = true;
          const steps = Math.min(5, TILE_COUNT - opp.position);
          traverse(opp, steps, ()=>{ traversing=false; el.rollBtn.disabled=false; cbDecision('continue'); });
        }});
      }
      if(card.effect==='opp2'){
        btns.push({label:'–ü–æ–¥–∞—Ä–∏—Ç—å 2 –±—Ä–æ—Å–∫–∞', cls:'btn-warning', cb: ()=>{
          closeModal();
          const opp = otherPlayer();
          opp.extraRolls = (opp.extraRolls||0) + 1; // –æ–¥–∏–Ω –¥–æ–ø, –∏—Ç–æ–≥–æ –¥–≤–∞ –ø–æ–¥—Ä—è–¥
          cbDecision('continue');
        }});
      }
      if(card.effect==='skipSelf'){
        btns.push({label:'–£—Å—Ç—É–ø–∏—Ç—å —Ö–æ–¥', cls:'btn-outline-danger', cb: ()=>{
          closeModal();
          currentPlayer().skipTurns = (currentPlayer().skipTurns||0) + 1;
          cbDecision('stop');
        }});
      }
      // universal ‚Äú–í—ã–ø–æ–ª–Ω–µ–Ω–æ‚Äù
      btns.push({label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ', cls:'btn-success', cb: ()=>{ closeModal(); cbDecision('continue'); }});
      btns.push({label:'–ù–µ –¥–µ–ª–∞—Ç—å ‚õî', cls:'btn-outline-secondary', cb: ()=>{ closeModal(); cbDecision('stop'); }});
    }else{
      btns.push({label:'–û–ö', cls:'btn-primary', cb: ()=>{ closeModal(); cbDecision('continue'); }});
    }

    showModal('–ò–°–ü–´–¢–ê–ù–ò–ï ‚ö†Ô∏è', `<div class="fs-5">${title}</div><div class="mt-2">${desc}</div>`, btns);
  }

  function win(p){
    if(gameOver) return;
    gameOver = true;
    try{ el.sfxWin.currentTime=0; el.sfxWin.play().catch(()=>{});}catch(e){}
    el.sideNotes.innerHTML = `<div class="fw-bold">–§–∏–Ω–∏—à!</div><div>${p.name} –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–∏.</div>`;
    showModal('–§–ò–ù–ò–® ‚ú®', `
      <p class="mb-1"><strong>${p.name}</strong> –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–ª–µ—Ç–∫–∏!</p>
      <p class="mb-2">–ì–ª–∞–≤–Ω–æ–µ ‚Äî –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –µ–¥–∏–Ω—Å—Ç–≤–æ. –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É!</p>
    `, [{label:'–û–ö', cls:'btn-primary', cb: closeModal}]);
  }

  // ---------- Start & UI ----------
  function startGame(){
    const names = [el.name1.value || '–ö—Ä–∞—Å–Ω—ã–µ', el.name2.value || '–°–∏–Ω–∏–µ'];
    players = [
      {id:0, name:names[0], color:'red',  position:1, skipTurns:0, extraRolls:0},
      {id:1, name:names[1], color:'blue', position:1, skipTurns:0, extraRolls:0},
    ];
    current = 0; gameOver=false; gameStarted=true; traversing=false; modalOpen=false;
    buildBoard(); placePawns(); fitBoard();
    el.turnName.textContent = players[0].name;
    el.sideNotes.innerHTML = `<div class="fw-bold">–°—Ç–∞—Ä—Ç</div><div>–ë—Ä–æ—Å–∞–π—Ç–µ –∫—É–±–∏–∫!</div>`;
    el.setup.setAttribute('aria-hidden','true');
    el.setup.style.display='none';
    // try start bgm quietly
    try{ el.bgm.volume = 0.25; el.bgm.play().then(()=>{ musicOn=true; el.musicBtn.textContent='–ú—É–∑—ã–∫–∞ ‚è∏Ô∏è'; }).catch(()=>{});}catch(e){}
  }

  function toggleFullscreen(){
    const elem = document.documentElement;
    if (!document.fullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen(); }
    else { if (document.exitFullscreen) document.exitFullscreen(); }
    setTimeout(()=>{ fitBoard(); placePawns(); }, 250);
  }

  function toggleMusic(){
    try{
      if(!musicOn){ el.bgm.volume = 0.25; el.bgm.play().catch(()=>{}); musicOn=true; el.musicBtn.textContent='–ú—É–∑—ã–∫–∞ ‚è∏Ô∏è'; }
      else { el.bgm.pause(); musicOn=false; el.musicBtn.textContent='–ú—É–∑—ã–∫–∞ ‚ñ∂Ô∏è'; }
    }catch(e){}
  }

  function skipTurn(){
    if(!gameStarted || gameOver || traversing || modalOpen) return;
    el.sideNotes.innerHTML = `<div class="fw-bold">–•–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω</div><div>${currentPlayer().name} —É—Å—Ç—É–ø–∞—é—Ç –æ—á–µ—Ä–µ–¥—å.</div>`;
    nextTurn();
  }

  // Events
  $('#startBtn').addEventListener('click', startGame);
  $('#rollBtn').addEventListener('click', roll);
  document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); roll(); }});
  $('#modalClose').addEventListener('click', closeModal);
  $('#endBtn').addEventListener('click', ()=>{ if(!gameOver){ showModal('–ó–∞–≤–µ—Ä—à–∏—Ç—å?', `<div>–ó–∞–∫–æ–Ω—á–∏—Ç—å –ø–∞—Ä—Ç–∏—é —Å–µ–π—á–∞—Å?</div>`, [{label:'–û—Ç–º–µ–Ω–∞', cls:'btn-secondary', cb: closeModal},{label:'–ó–∞–≤–µ—Ä—à–∏—Ç—å', cls:'btn-danger', cb: ()=>{ closeModal(); gameOver=true; }}]); }});
  $('#fsBtn').addEventListener('click', toggleFullscreen);
  $('#fsBtnSetup').addEventListener('click', toggleFullscreen);
  $('#musicBtn').addEventListener('click', toggleMusic);
  $('#skipTurnBtn').addEventListener('click', skipTurn);

  // Initial
  buildBoard(); fitBoard();
})();
</script>
</body>
</html>